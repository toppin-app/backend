<style>
  body {
    background: #f8f9fa;
  }
  
  .utilities-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 25px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
  }
  
  .utilities-header h1 {
    font-size: 22px;
    font-weight: 600;
    margin: 0 0 4px 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .utilities-header h1 i {
    font-size: 20px;
  }
  
  .utilities-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 13px;
  }
  
  .utilities-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
  }
  
  .utility-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    border-left: 3px solid #667eea;
    transition: all 0.3s ease;
    position: relative;
  }
  
  .utility-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  
  .utility-card h3 {
    color: #2d3748;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .utility-card h3 i {
    color: #667eea;
    font-size: 18px;
  }
  
  .utility-card > p {
    color: #718096;
    line-height: 1.5;
    margin-bottom: 12px;
    font-size: 13px;
  }
  
  .info-badge {
    background: #e0f2fe;
    border: 1px solid #7dd3fc;
    border-radius: 6px;
    padding: 8px 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
  }
  
  .info-badge i {
    color: #0369a1;
    font-size: 14px;
  }
  
  .info-badge strong {
    color: #0c4a6e;
  }
  
  .warning-badge {
    background: #fef3c7;
    border: 1px solid #fbbf24;
    border-radius: 6px;
    padding: 8px 12px;
    margin: 10px 0;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
  }
  
  .warning-badge i {
    color: #d97706;
    font-size: 14px;
  }
  
  .warning-badge strong {
    color: #78350f;
  }
  
  .btn-start {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white !important;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 6px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
  }
  
  .btn-start i {
    font-size: 13px;
    color: white !important;
  }
  
  .btn-start:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    color: white !important;
    text-decoration: none;
  }
  
  .btn-start:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .status-running {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #fef3c7;
    color: #78350f;
    padding: 6px 12px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 12px;
    margin-left: 10px;
  }
  
  .progress-container {
    display: none;
    margin-top: 20px;
    padding: 20px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
  }
  
  .progress-container.active {
    display: block;
    animation: slideIn 0.3s ease;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .spinner-container {
    display: flex;
    justify-content: center;
    margin-bottom: 15px;
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(102, 126, 234, 0.1);
    border-top: 3px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .status-title {
    text-align: center;
    color: #2d3748;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 15px;
  }
  
  .progress-wrapper {
    position: relative;
    margin-bottom: 15px;
  }
  
  .progress {
    height: 28px;
    background: #e2e8f0;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
  }
  
  .progress-bar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: width 0.4s ease;
    font-weight: 600;
    font-size: 13px;
    color: white;
  }
  
  .current-user-info {
    text-align: center;
    padding: 10px;
    background: white;
    border-radius: 6px;
    margin-bottom: 15px;
    color: #4a5568;
    font-size: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }
  
  .current-user-info i {
    color: #667eea;
    margin-right: 6px;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-top: 0;
  }
  
  .stat-box {
    background: white;
    padding: 12px;
    border-radius: 6px;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    transition: all 0.2s ease;
    border: 1px solid #e2e8f0;
  }
  
  .stat-box:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
  
  .stat-number {
    font-size: 24px;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 4px;
  }
  
  .stat-number.text-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .stat-number.text-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .stat-number.text-danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .stat-label {
    font-size: 10px;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }
  
  .completed-message {
    display: none;
    margin-top: 15px;
    animation: slideIn 0.3s ease;
  }
  
  .success-alert {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    border: 2px solid #34d399;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
  }
  
  .success-alert i {
    color: #059669;
    margin-bottom: 10px;
  }
  
  .success-alert h5 {
    color: #065f46;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
  }
  
  .success-alert p {
    color: #047857;
    margin-bottom: 12px;
    font-size: 13px;
  }
  
  .btn-reload {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
    color: white;
    padding: 10px 20px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 6px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    cursor: pointer;
  }
  
  .btn-reload:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(16, 185, 129, 0.4);
  }
  
  @media (max-width: 768px) {
    .utilities-grid {
      grid-template-columns: 1fr;
    }
    
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .user-card {
      flex-direction: column !important;
      align-items: flex-start !important;
    }
    
    .user-card > div:last-child {
      width: 100%;
      justify-content: space-between;
    }
  }
  
  .user-card {
    transition: all 0.2s ease;
  }
  
  .user-card:hover {
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15) !important;
    border-color: #667eea !important;
  }
  
  .form-select {
    cursor: pointer !important;
    transition: all 0.3s ease;
  }
  
  .form-select:hover {
    border-color: #667eea !important;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15) !important;
  }
  
  .form-select:focus {
    border-color: #667eea !important;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25) !important;
  }
</style>

<div class="container-fluid">
  <div class="utilities-header">
    <h1>
      <i class="fas fa-tools"></i>
      Configuraci√≥n y Utilidades
    </h1>
    <p>Herramientas administrativas para mantenimiento del sistema</p>
  </div>

  <div class="utilities-grid">
    <!-- Utilidad: Test de Emails -->
    <div class="utility-card">
      <h3><i class="fas fa-envelope"></i> Test de Emails</h3>
      <p>
        Prueba el sistema de env√≠o de emails con Mailjet. Env√≠a emails de prueba para verificar la configuraci√≥n.
      </p>
      
      <div class="info-badge">
        <i class="fas fa-info-circle"></i> 
        <div>
          <strong>Servicio:</strong> Mailjet
        </div>
      </div>

      <%= link_to admin_mailer_test_path, class: 'btn-start' do %>
        <i class="fas fa-paper-plane"></i> Abrir Test de Emails
      <% end %>
    </div>

    <!-- Utilidad: Poblar Ubicaciones -->
    <div class="utility-card">
      <h3><i class="fas fa-map-marker-alt"></i> Poblar Ubicaciones</h3>
      <p>
        Geocoding reverso para usuarios con coordenadas pero sin ciudad/pa√≠s.
      </p>
      
      <div class="info-badge">
        <i class="fas fa-info-circle"></i> 
        <div>
          <strong>Usuarios pendientes:</strong> <%= @users_needing_location %> usuarios
        </div>
      </div>

      <% if @users_needing_location > 0 %>
        <div class="warning-badge">
          <i class="fas fa-clock"></i>
          <div>
            <strong>Tiempo estimado:</strong> ~<%= @users_needing_location %> segundos
          </div>
        </div>
      <% end %>

      <button id="startPopulateBtn" class="btn-start" onclick="startPopulateLocations()" 
              <%= 'disabled' if @users_needing_location == 0 || (@current_progress && @current_progress[:status] == 'running') %>>
        <i class="fas fa-rocket"></i> Iniciar
      </button>

      <% if @current_progress && @current_progress[:status] == 'running' %>
        <span class="status-running">
          <i class="fas fa-spinner fa-spin"></i> En ejecuci√≥n
        </span>
      <% end %>

      <!-- Contenedor de Proceso -->
      <div id="processContainer" class="progress-container <%= 'active' if @current_progress && @current_progress[:status] == 'running' %>">
        <div class="spinner-container">
          <div class="spinner"></div>
        </div>
        
        <h4 class="status-title">Procesando ubicaciones...</h4>
        
        <p style="text-align: center; color: #64748b; font-size: 13px; margin-top: 15px;">
          Este proceso puede tardar varios minutos.<br>
          Puedes cerrar esta ventana y volver m√°s tarde.<br>
          <strong>Tiempo estimado: ~<%= @users_needing_location %> segundos</strong>
        </p>

        <button class="btn-reload" onclick="window.location.reload()" style="margin-top: 20px;">
          <i class="fas fa-sync-alt"></i> Verificar Estado
        </button>
      </div>

      <% if @current_progress && @current_progress[:status] == 'completed' %>
        <div class="completed-message" style="display: block; margin-top: 15px;">
          <div class="success-alert">
            <i class="fas fa-check-circle fa-3x"></i>
            <h5>¬°Proceso Completado!</h5>
            <p>
              Total: <%= @current_progress[:total] %> | 
              Procesados: <%= @current_progress[:processed] %> | 
              Sin datos: <%= @current_progress[:skipped] %> | 
              Errores: <%= @current_progress[:errors] %>
            </p>
            <button class="btn-reload" onclick="clearProgress()">
              <i class="fas fa-check"></i> Aceptar
            </button>
          </div>
        </div>
      <% end %>
    </div>
    <!-- Fin de Utilidad: Poblar Ubicaciones -->
    
    <!-- Utilidad: Poblar Device Platform -->
    <div class="utility-card">
      <h3><i class="fas fa-mobile-alt"></i> Poblar Plataforma de Dispositivos</h3>
      <p>
        Detecta autom√°ticamente iOS/Android bas√°ndose en el patr√≥n del device_id de los usuarios.
      </p>
      
      <div class="info-badge">
        <i class="fas fa-info-circle"></i> 
        <div>
          <strong>Usuarios pendientes:</strong> <%= @users_needing_platform %> usuarios
        </div>
      </div>

      <div class="stats-grid" style="margin-top: 10px; margin-bottom: 10px;">
        <div class="stat-box">
          <div class="stat-number"><%= @users_with_platform %></div>
          <div class="stat-label">Con Plataforma</div>
        </div>
        <div class="stat-box">
          <div class="stat-number text-success"><%= @ios_users %></div>
          <div class="stat-label">iOS</div>
        </div>
        <div class="stat-box">
          <div class="stat-number text-success"><%= @android_users %></div>
          <div class="stat-label">Android</div>
        </div>
        <div class="stat-box">
          <div class="stat-number text-warning"><%= @users_needing_platform %></div>
          <div class="stat-label">Sin Detectar</div>
        </div>
      </div>

      <button id="startPlatformBtn" class="btn-start" onclick="startPopulatePlatforms()" 
              <%= 'disabled' if @users_needing_platform == 0 || (@platform_progress && @platform_progress[:status] == 'running') %>>
        <i class="fas fa-rocket"></i> Iniciar Detecci√≥n
      </button>

      <% if @platform_progress && @platform_progress[:status] == 'running' %>
        <span class="status-running">
          <i class="fas fa-spinner fa-spin"></i> En ejecuci√≥n
        </span>
      <% end %>

      <!-- Contenedor de Proceso -->
      <div id="platformProcessContainer" class="progress-container <%= 'active' if @platform_progress && @platform_progress[:status] == 'running' %>">
        <div class="spinner-container">
          <div class="spinner"></div>
        </div>
        
        <h4 class="status-title">Detectando plataformas...</h4>
        
        <div id="platformProgress" class="progress-wrapper">
          <div class="progress">
            <div id="platformProgressBar" class="progress-bar" style="width: 0%">
              0%
            </div>
          </div>
        </div>

        <div id="platformCurrentUser" class="current-user-info" style="display: none;">
          <i class="fas fa-user"></i>
          Procesando usuario <strong id="platformUserName"></strong> (<span id="platformUserIndex"></span>/<span id="platformUserTotal"></span>)
        </div>

        <div id="platformStats" class="stats-grid">
          <div class="stat-box">
            <div class="stat-number" id="platformTotalCount">0</div>
            <div class="stat-label">Total</div>
          </div>
          <div class="stat-box">
            <div class="stat-number text-success" id="platformIosCount">0</div>
            <div class="stat-label">iOS</div>
          </div>
          <div class="stat-box">
            <div class="stat-number text-success" id="platformAndroidCount">0</div>
            <div class="stat-label">Android</div>
          </div>
          <div class="stat-box">
            <div class="stat-number text-warning" id="platformSkippedCount">0</div>
            <div class="stat-label">Omitidos</div>
          </div>
        </div>
      </div>

      <% if @platform_progress && @platform_progress[:status] == 'completed' %>
        <div class="completed-message" style="display: block; margin-top: 15px;">
          <div class="success-alert">
            <i class="fas fa-check-circle fa-3x"></i>
            <h5>¬°Proceso Completado!</h5>
            <p>
              Total: <%= @platform_progress[:total] %> | 
              iOS: <%= @platform_progress[:ios_detected] %> | 
              Android: <%= @platform_progress[:android_detected] %> | 
              Omitidos: <%= @platform_progress[:skipped] %>
            </p>
            <button class="btn-reload" onclick="clearPlatformProgress()">
              <i class="fas fa-check"></i> Aceptar
            </button>
          </div>
        </div>
      <% end %>
    </div>
    <!-- Fin de Utilidad: Poblar Device Platform -->
    
    <!-- Utilidad: Validar Usuarios Incompletos -->
    <div class="utility-card">
      <h3><i class="fas fa-user-check"></i> Validar Datos de Usuarios</h3>
      <p>
        Encuentra usuarios que no tengan datos requeridos y elim√≠nalos de forma individual o masiva.
      </p>
      
      <%= form_with url: find_incomplete_users_admin_utilities_path, method: :get, local: true, id: 'validationForm' do |f| %>
        <div class="info-badge">
          <i class="fas fa-filter"></i> 
          <div style="flex: 1;">
            <strong>Campo a validar:</strong>
            <%= f.select :field_to_validate, 
                [
                  ['Imagen de perfil', 'image'],
                  ['Nombre', 'name'],
                  ['Email', 'email'],
                  ['G√©nero', 'gender'],
                  ['Fecha de nacimiento', 'birthday'],
                  ['Descripci√≥n', 'description'],
                  ['Ubicaci√≥n (pa√≠s)', 'location_country'],
                  ['Ubicaci√≥n (ciudad)', 'location_city'],
                  ['Coordenadas (lat/lng)', 'coordinates'],
                  ['Ocupaci√≥n', 'occupation'],
                  ['Estudios', 'studies']
                ],
                { selected: params[:field_to_validate] },
                { class: 'form-select', style: 'margin-top: 8px; cursor: pointer;' }
            %>
          </div>
        </div>

        <%= f.submit 'Buscar Usuarios', class: 'btn-start', style: 'margin-top: 10px;' %>
      <% end %>

      <% if @incomplete_users %>
        <div style="margin-top: 20px;">
          <div class="warning-badge">
            <i class="fas fa-users"></i>
            <div>
              <strong>Encontrados:</strong> <span id="totalUsersCount"><%= @incomplete_users.count %></span> usuarios sin <%= @field_label %>
            </div>
          </div>

          <% if @incomplete_users.any? %>
            <%= form_with url: bulk_delete_users_admin_utilities_path, method: :delete, local: false, id: 'bulkDeleteForm' do |f| %>
              <div style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" class="btn-start" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);" onclick="selectAll()">
                  <i class="fas fa-check-double"></i> Seleccionar todos
                </button>
                <button type="button" class="btn-start" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);" onclick="deselectAll()">
                  <i class="fas fa-times"></i> Deseleccionar todos
                </button>
                <button type="submit" class="btn-start" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);" onclick="return confirm('¬øEst√°s seguro de eliminar los usuarios seleccionados?')">
                  <i class="fas fa-trash"></i> Eliminar seleccionados (<span id="selectedCount">0</span>)
                </button>
              </div>

              <div style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; background: #f8fafc;">
                <% @incomplete_users.each do |user| %>
                  <div class="user-card" id="user-card-<%= user.id %>" style="background: white; border-radius: 6px; padding: 15px; margin-bottom: 10px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 15px;">
                    <div style="flex-shrink: 0;">
                      <%= check_box_tag "user_ids[]", user.id, false, class: 'user-checkbox', style: 'width: 20px; height: 20px; cursor: pointer;', onchange: 'updateSelectedCount()' %>
                    </div>
                    
                    <div style="flex-shrink: 0; width: 60px; height: 60px; border-radius: 50%; overflow: hidden; background: #e2e8f0; display: flex; align-items: center; justify-content: center;">
                      <% if user.user_media.any? && user.user_media.first.file.url.present? %>
                        <%= image_tag user.user_media.first.file.thumb.url, style: 'width: 100%; height: 100%; object-fit: cover;' %>
                      <% else %>
                        <i class="fas fa-user" style="font-size: 24px; color: #9ca3af;"></i>
                      <% end %>
                    </div>

                    <div style="flex: 1; min-width: 0;">
                      <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                        <%= user.name.presence || 'Sin nombre' %>
                        <% if user.user_gen %>
                          <span style="background: #fef3c7; color: #78350f; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">FAKE</span>
                        <% end %>
                        <% if user.blocked %>
                          <span style="background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">BLOQUEADO</span>
                        <% end %>
                      </div>
                      <div style="font-size: 13px; color: #6b7280; margin-bottom: 2px;">
                        <i class="fas fa-envelope" style="width: 14px;"></i> <%= user.email %>
                      </div>
                      <div style="font-size: 12px; color: #9ca3af;">
                        <i class="fas fa-calendar" style="width: 14px;"></i> Registro: <%= user.created_at.strftime("%d/%m/%Y") %>
                      </div>
                    </div>

                    <div style="flex-shrink: 0; display: flex; gap: 8px;">
                      <%= link_to show_user_path(user), class: 'btn-start', style: 'padding: 8px 12px; font-size: 12px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);', title: 'Ver usuario' do %>
                        <i class="fas fa-eye"></i>
                      <% end %>
                      <%= link_to destroy_user_path(id: user.id), method: :delete, remote: true, data: { confirm: '¬øEliminar este usuario?' }, class: 'btn-start', style: 'padding: 8px 12px; font-size: 12px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);', title: 'Eliminar' do %>
                        <i class="fas fa-trash"></i>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
    <!-- Fin de Utilidad: Validar Usuarios Incompletos -->

    <!-- Utilidad: Validador de TMDB -->
    <div class="utility-card">
      <h3><i class="fas fa-film"></i> Validador de TMDB</h3>
      <p>
        Encuentra pel√≠culas y series con datos incompletos (undefined, null, vac√≠os) en The Movie Database.
      </p>
      
      <%= form_with url: validate_tmdb_admin_utilities_path, method: :get, local: true, id: 'tmdbValidationForm' do |f| %>
        <div class="info-badge">
          <i class="fas fa-filter"></i> 
          <div style="flex: 1;">
            <strong>Tipo de contenido:</strong>
            <%= f.select :content_type, 
                [
                  ['Pel√≠culas', 'movies'],
                  ['Series', 'series']
                ],
                { selected: params[:content_type] },
                { class: 'form-select', style: 'margin-top: 8px; cursor: pointer;' }
            %>
          </div>
        </div>

        <%= f.submit 'Buscar Problemas', class: 'btn-start', style: 'margin-top: 10px;' %>
      <% end %>

      <% if @tmdb_problems %>
        <div style="margin-top: 20px;">
          <div class="warning-badge">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
              <strong>Problemas encontrados:</strong> <%= @tmdb_problems.count %> <%= @content_type_label %>
            </div>
          </div>

          <% if @tmdb_problems.any? %>
            <div style="margin-bottom: 15px;">
              <%= link_to "üîß Reparar todos los problemas (#{@tmdb_problems.count})", 
                  fix_all_tmdb_admin_utilities_path(content_type: params[:content_type]),
                  method: :post,
                  data: { confirm: "¬øEst√°s seguro de eliminar TODOS los registros problem√°ticos de #{@content_type_label}? Esta acci√≥n no se puede deshacer." },
                  class: 'btn-start',
                  style: 'background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); display: inline-block;' %>
            </div>

            <div style="max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; background: #f8fafc; margin-top: 15px;">
              <% @tmdb_problems.each do |item| %>
                <div class="user-card" style="background: white; border-radius: 6px; padding: 15px; margin-bottom: 10px; border: 1px solid #fecaca;">
                  <div style="display: flex; gap: 15px;">
                    <div style="flex-shrink: 0; width: 60px; height: 90px; border-radius: 4px; overflow: hidden; background: #f3f4f6; display: flex; align-items: center; justify-content: center;">
                      <% if item.poster_path.present? && item.poster_path != 'undefined' && item.poster_path != 'null' %>
                        <%= image_tag "https://image.tmdb.org/t/p/w92#{item.poster_path}", style: 'width: 100%; height: 100%; object-fit: cover;' %>
                      <% else %>
                        <i class="fas fa-image" style="font-size: 24px; color: #9ca3af;"></i>
                      <% end %>
                    </div>

                    <div style="flex: 1;">
                      <div style="font-weight: 600; color: #1f2937; margin-bottom: 8px;">
                        <%= item.title || item.name || '<sin t√≠tulo>' %>
                      </div>
                      
                      <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px;">
                        <span style="background: #dbeafe; color: #1e40af; padding: 3px 10px; border-radius: 4px; font-size: 12px;">
                          <strong>TMDB ID:</strong> <%= item.tmdb_id || 'N/A' %>
                        </span>
                        
                        <span style="background: #e0e7ff; color: #4338ca; padding: 3px 10px; border-radius: 4px; font-size: 12px;">
                          <strong>Usuarios:</strong> <%= item.user_count %> usuario(s)
                        </span>
                      </div>

                      <div style="background: #fef2f2; border-left: 3px solid #ef4444; padding: 10px; border-radius: 4px; font-size: 13px;">
                        <strong style="color: #dc2626; display: block; margin-bottom: 5px;">
                          <i class="fas fa-bug"></i> Problemas detectados:
                        </strong>
                        <% item.issues.each do |issue| %>
                          <div style="color: #991b1b; margin-bottom: 3px;">‚Ä¢ <%= issue %></div>
                        <% end %>
                      </div>

                      <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <%= link_to fix_tmdb_problem_admin_utilities_path(tmdb_id: item.tmdb_id, content_type: params[:content_type]), 
                            method: :post,
                            data: { confirm: "¬øEliminar todos los registros con TMDB ID #{item.tmdb_id}? Afectar√° a #{item.user_count} usuario(s)." },
                            class: 'btn-start', 
                            style: 'display: inline-block; padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);' do %>
                          <i class="fas fa-wrench"></i> Reparar problema
                        <% end %>
                        
                        <a href="#" 
                           onclick="showAffectedUsers(#{item.affected_user_ids.to_json.html_safe}, '#{item.title || item.name}'); return false;"
                           class="btn-start"
                           style="display: inline-block; padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                          <i class="fas fa-users"></i> Ver usuarios (#{item.affected_user_ids.count})
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div style="margin-top: 15px; padding: 20px; background: #d1fae5; border-radius: 8px; text-align: center; color: #065f46;">
              <i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 10px;"></i>
              <p style="margin: 0; font-weight: 600;">¬°No se encontraron problemas! Todas las <%= @content_type_label %> tienen datos completos.</p>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
    <!-- Fin de Utilidad: Validador de TMDB -->
    
    <!-- Aqu√≠ se pueden agregar m√°s utilidades en el futuro -->
    
  </div>
</div>

<!-- Loading Overlay -->
<div id="deleteLoadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; justify-content: center; align-items: center;">
  <div style="text-align: center; color: white;">
    <div style="border: 8px solid #f3f3f3; border-top: 8px solid #3b82f6; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
    <p style="margin-top: 20px; font-size: 18px; font-weight: bold;">Eliminando usuarios...</p>
  </div>
</div>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<script>
function startPopulateLocations() {
  const btn = document.getElementById('startPopulateBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando...';
  
  fetch('<%= populate_locations_admin_utilities_path %>', {
    method: 'POST',
    headers: {
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    document.getElementById('processContainer').classList.add('active');
    btn.style.display = 'none';
  })
  .catch(error => {
    alert('Error al iniciar el proceso: ' + error);
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-rocket"></i> Iniciar';
  });
}

function clearProgress() {
  fetch('<%= clear_location_progress_admin_utilities_path %>', {
    method: 'DELETE',
    headers: {
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
    }
  })
  .then(() => {
    window.location.reload();
  });
}

function startPopulatePlatforms() {
  const btn = document.getElementById('startPlatformBtn');
  const container = document.getElementById('platformProcessContainer');
  
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
  container.classList.add('active');
  
  console.log('üöÄ Iniciando proceso de detecci√≥n de plataformas...');
  
  fetch('<%= populate_device_platforms_admin_utilities_path %>', {
    method: 'POST',
    headers: {
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    console.log('‚úÖ Respuesta del servidor:', data);
    
    if (data.result && data.result.status === 'completed') {
      // Mostrar resultado inmediato
      container.innerHTML = `
        <div class="success-alert" style="display: block;">
          <i class="fas fa-check-circle fa-3x"></i>
          <h5>¬°Proceso Completado!</h5>
          <p>
            Total: ${data.result.total || 0} | 
            iOS: ${data.result.ios_detected || 0} | 
            Android: ${data.result.android_detected || 0} | 
            Omitidos: ${data.result.skipped || 0}
          </p>
          <button class="btn-reload" onclick="window.location.reload()">
            <i class="fas fa-check"></i> Aceptar
          </button>
        </div>
      `;
    } else if (data.error) {
      alert('Error: ' + data.error);
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-rocket"></i> Iniciar Detecci√≥n';
      container.classList.remove('active');
    }
  })
  .catch(error => {
    console.error('‚ùå Error al iniciar el proceso:', error);
    alert('Error al iniciar el proceso: ' + error);
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-rocket"></i> Iniciar Detecci√≥n';
    container.classList.remove('active');
  });
}

function checkPlatformProgress() {
  fetch('<%= platform_progress_admin_utilities_path %>')
    .then(response => response.json())
    .then(data => {
      console.log('üìä Platform progress:', data);
      
      if (data.status === 'running') {
        updatePlatformProgress(data);
        setTimeout(checkPlatformProgress, 1000);
      } else if (data.status === 'completed') {
        console.log('‚úÖ Proceso completado!');
        updatePlatformProgress(data);
        // Ocultar spinner y mostrar mensaje de √©xito
        document.getElementById('platformProcessContainer').innerHTML = `
          <div class="success-alert" style="display: block;">
            <i class="fas fa-check-circle fa-3x"></i>
            <h5>¬°Proceso Completado!</h5>
            <p>
              Total: ${data.total || 0} | 
              iOS: ${data.ios_detected || 0} | 
              Android: ${data.android_detected || 0} | 
              Omitidos: ${data.skipped || 0}
            </p>
            <button class="btn-reload" onclick="clearPlatformProgress()">
              <i class="fas fa-check"></i> Aceptar
            </button>
          </div>
        `;
      } else if (data.status === 'error') {
        console.error('‚ùå Error en el proceso:', data.error_message);
        alert('Error en el proceso: ' + (data.error_message || 'Error desconocido'));
        window.location.reload();
      } else {
        // Status es 'idle' o no hay proceso - podr√≠a ser que a√∫n no inici√≥
        console.warn('‚ö†Ô∏è Status recibido:', data.status, '- Reintentando en 1 segundo...');
        setTimeout(checkPlatformProgress, 1000);
      }
    })
    .catch(error => {
      console.error('‚ùå Error checking progress:', error);
      setTimeout(checkPlatformProgress, 2000);
    });
}


function updatePlatformProgress(data) {
  const percentage = data.total > 0 ? Math.round((data.processed / data.total) * 100) : 0;
  
  console.log('Updating progress:', {
    total: data.total,
    processed: data.processed,
    percentage: percentage,
    status: data.status
  });
  
  const progressBar = document.getElementById('platformProgressBar');
  if (progressBar) {
    progressBar.style.width = percentage + '%';
    progressBar.textContent = percentage + '%';
  }
  
  if (data.current_user) {
    const currentUserDiv = document.getElementById('platformCurrentUser');
    const userNameSpan = document.getElementById('platformUserName');
    const userIndexSpan = document.getElementById('platformUserIndex');
    const userTotalSpan = document.getElementById('platformUserTotal');
    
    if (currentUserDiv) currentUserDiv.style.display = 'block';
    if (userNameSpan) userNameSpan.textContent = data.current_user.name || 'Usuario ' + data.current_user.id;
    if (userIndexSpan) userIndexSpan.textContent = data.current_user.index;
    if (userTotalSpan) userTotalSpan.textContent = data.total;
  }
  
  const totalCount = document.getElementById('platformTotalCount');
  const iosCount = document.getElementById('platformIosCount');
  const androidCount = document.getElementById('platformAndroidCount');
  const skippedCount = document.getElementById('platformSkippedCount');
  
  if (totalCount) totalCount.textContent = data.total || 0;
  if (iosCount) iosCount.textContent = data.ios_detected || 0;
  if (androidCount) androidCount.textContent = data.android_detected || 0;
  if (skippedCount) skippedCount.textContent = data.skipped || 0;
}

function clearPlatformProgress() {
  fetch('<%= clear_platform_progress_admin_utilities_path %>', {
    method: 'DELETE',
    headers: {
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
    }
  })
  .then(() => {
    window.location.reload();
  });
}

function selectAll() {
  document.querySelectorAll('.user-checkbox').forEach(checkbox => {
    checkbox.checked = true;
  });
  updateSelectedCount();
}

function deselectAll() {
  document.querySelectorAll('.user-checkbox').forEach(checkbox => {
    checkbox.checked = false;
  });
  updateSelectedCount();
}

function updateSelectedCount() {
  const count = document.querySelectorAll('.user-checkbox:checked').length;
  const countElement = document.getElementById('selectedCount');
  if (countElement) {
    countElement.textContent = count;
  }
}

function updateTotalCount() {
  const totalCards = document.querySelectorAll('.user-card').length;
  const totalCountElement = document.getElementById('totalUsersCount');
  if (totalCountElement) {
    totalCountElement.textContent = totalCards;
  }
  // Tambi√©n actualizar el contador de seleccionados
  updateSelectedCount();
}

function showLoading() {
  const overlay = document.getElementById('deleteLoadingOverlay');
  if (overlay) {
    overlay.style.display = 'flex';
  }
}

function hideLoading() {
  const overlay = document.getElementById('deleteLoadingOverlay');
  if (overlay) {
    overlay.style.display = 'none';
  }
}

// Escuchar eventos AJAX de Rails
document.addEventListener('DOMContentLoaded', function() {
  // Iniciar monitoreo si hay un proceso de plataforma en ejecuci√≥n
  <% if @platform_progress && @platform_progress[:status] == 'running' %>
    checkPlatformProgress();
  <% end %>
  
  document.addEventListener('ajax:beforeSend', function(event) {
    // Verificar si es una eliminaci√≥n
    const target = event.target;
    if (target.matches('[data-remote="true"]') && target.matches('[data-method="delete"]')) {
      showLoading();
    } else if (target.id === 'bulkDeleteForm') {
      showLoading();
    }
  });

  document.addEventListener('ajax:success', function(event) {
    hideLoading();
  });

  document.addEventListener('ajax:complete', function(event) {
    hideLoading();
  });

  document.addEventListener('ajax:error', function(event) {
    hideLoading();
    alert('Error al eliminar usuario(s). Por favor, intenta de nuevo.');
  });

  // Funci√≥n para mostrar usuarios afectados por problemas de TMDB
  function showAffectedUsers(userIds, title) {
    const userList = userIds.map(id => `
      <div style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
        <a href="/users/${id}" target="_blank" style="color: #3b82f6; text-decoration: none; font-weight: 500;">
          <i class="fas fa-user"></i> Usuario ID: ${id}
        </a>
      </div>
    `).join('');

    const modal = `
      <div id="affectedUsersModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; display: flex; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #1f2937;">
              <i class="fas fa-users"></i> Usuarios Afectados
            </h3>
            <button onclick="closeAffectedUsersModal()" style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
            <strong style="color: #374151;">Contenido:</strong> ${title}
          </div>
          
          <div style="background: #fef2f2; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #ef4444;">
            <strong style="color: #dc2626;">
              <i class="fas fa-exclamation-triangle"></i> Total de usuarios afectados: ${userIds.length}
            </strong>
          </div>
          
          <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
            ${userList}
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modal);
  }

  function closeAffectedUsersModal() {
    const modal = document.getElementById('affectedUsersModal');
    if (modal) {
      modal.remove();
    }
  }
});
</script>
