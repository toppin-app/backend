<div class="row">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header bg-white">
        <h3 class="mb-0"><%= @publi.title %></h3>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-sm-4">
            <strong>Fecha de inicio:</strong>
          </div>
          <div class="col-sm-8">
            <%= @publi.start_date.strftime("%d-%m-%Y %H:%M") %>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4">
            <strong>Fecha de fin:</strong>
          </div>
          <div class="col-sm-8">
            <%= @publi.end_date.strftime("%d-%m-%Y %H:%M") %>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4">
            <strong>Días de la semana:</strong>
          </div>
          <div class="col-sm-8">
            <%= weekday(@publi.weekdays) %>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4">
            <strong>Horario:</strong>
          </div>
          <div class="col-sm-8">
            Desde las <%= @publi.start_time.strftime("%H:%M") %> hasta las <%= @publi.end_time.strftime("%H:%M") %>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4">
            <strong>Link:</strong>
          </div>
          <div class="col-sm-8">
            <% if @publi.link.present? %>
              <%= link_to @publi.link, @publi.link, target: '_blank', class: 'text-primary' %>
              <i class="fas fa-external-link-alt ml-1 text-muted" style="font-size: 12px;"></i>
            <% else %>
              <em class="text-muted">Sin link</em>
            <% end %>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4">
            <strong>Cancelable:</strong>
          </div>
          <div class="col-sm-8">
            <% if @publi.cancellable %>
              <span class="badge badge-success">Sí</span>
            <% else %>
              <span class="badge badge-secondary">No</span>
            <% end %>
          </div>
        </div>

        <div class="row">
          <div class="col-sm-4">
            <strong>Cada cuántos swipes:</strong>
          </div>
          <div class="col-sm-8">
            <span class="badge badge-info"><%= @publi.repeat_swipes %></span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card">
      <div class="card-header bg-white">
        <h5 class="mb-0">Vista previa</h5>
      </div>
      <div class="card-body text-center">
        <% if @publi.image? %>
          <div class="mb-3">
            <p class="text-muted small mb-2">Imagen:</p>
            <%= image_tag @publi.image.url, class: 'img-fluid rounded', style: 'max-height: 250px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);' %>
          </div>
        <% end %>
        
        <% if @publi.video? %>
          <div class="mb-3">
            <p class="text-muted small mb-2">Video:</p>
            <%= video_tag @publi.video.url, controls: true, class: 'img-fluid rounded', style: 'max-height: 250px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);' %>
          </div>
        <% end %>
        
        <% if !@publi.image? && !@publi.video? %>
          <i class="fas fa-image" style="font-size: 80px; color: #ccc;"></i>
          <p class="text-muted mt-2">No hay multimedia</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Panel de Rendimiento de Campaña -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-white d-flex align-items-center">
        <i class="fas fa-chart-line text-primary mr-2" style="font-size: 24px;"></i>
        <h4 class="mb-0">Rendimiento de Campaña</h4>
      </div>
      <div class="card-body">
        <!-- Métricas principales -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card bg-light border-0">
              <div class="card-body text-center">
                <i class="fas fa-eye text-primary mb-2" style="font-size: 32px;"></i>
                <h2 class="mb-0"><%= @total_impressions %></h2>
                <p class="text-muted mb-0">Impresiones Totales</p>
              </div>
            </div>
          </div>
          
          <div class="col-md-3">
            <div class="card bg-light border-0">
              <div class="card-body text-center">
                <i class="fas fa-users text-success mb-2" style="font-size: 32px;"></i>
                <h2 class="mb-0"><%= @unique_viewers %></h2>
                <p class="text-muted mb-0">Usuarios Únicos</p>
              </div>
            </div>
          </div>
          
          <div class="col-md-3">
            <div class="card bg-light border-0">
              <div class="card-body text-center">
                <i class="fas fa-redo text-info mb-2" style="font-size: 32px;"></i>
                <h2 class="mb-0"><%= @total_impressions > 0 ? (@total_impressions.to_f / @unique_viewers).round(2) : 0 %></h2>
                <p class="text-muted mb-0">Promedio Vistas/Usuario</p>
              </div>
            </div>
          </div>
          
          <div class="col-md-3">
            <div class="card bg-light border-0">
              <div class="card-body text-center">
                <i class="fas fa-calendar-day text-warning mb-2" style="font-size: 32px;"></i>
                <h2 class="mb-0"><%= ((Time.now - @publi.created_at) / 1.day).round %></h2>
                <p class="text-muted mb-0">Días Activa</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Gráfica de impresiones por día -->
        <% if @impressions_by_day.any? %>
          <div class="row mb-4">
            <div class="col-12">
              <h5 class="mb-3"><i class="fas fa-chart-area mr-2"></i>Distribución Temporal (Últimos 30 días)</h5>
              <div class="card border-0" style="background-color: #f8f9fa;">
                <div class="card-body">
                  <canvas id="impressionsChart" height="80"></canvas>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <!-- Desglose por plataforma y género -->
        <div class="row mb-4">
          <div class="col-md-6">
            <h5 class="mb-3"><i class="fas fa-mobile-alt mr-2"></i>Distribución por Plataforma</h5>
            <div class="card border-0 bg-light">
              <div class="card-body">
                <% # device_platform: 0 = iOS, 1 = Android %>
                <% platform_names = { 0 => 'iOS', 1 => 'Android' } %>
                <% if @impressions_by_platform.any? %>
                  <% @impressions_by_platform.each do |platform, count| %>
                    <% platform_name = platform_names[platform] || 'Desconocido' %>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <div>
                        <i class="<%= platform == 0 ? 'fab fa-apple' : platform == 1 ? 'fab fa-android' : 'fas fa-question-circle' %>" style="font-size: 24px; color: <%= platform == 0 ? '#000' : platform == 1 ? '#3DDC84' : '#ccc' %>;"></i>
                        <strong class="ml-2"><%= platform_name %></strong>
                      </div>
                      <div>
                        <span class="badge badge-primary" style="font-size: 16px;"><%= count %></span>
                        <span class="text-muted small">(<%= ((count.to_f / @total_impressions) * 100).round(1) %>%)</span>
                      </div>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                      <div class="progress-bar" role="progressbar" style="width: <%= (count.to_f / @total_impressions) * 100 %>%;" aria-valuenow="<%= count %>" aria-valuemin="0" aria-valuemax="<%= @total_impressions %>"></div>
                    </div>
                  <% end %>
                <% else %>
                  <p class="text-muted text-center mb-0">Sin datos de plataforma</p>
                <% end %>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <h5 class="mb-3"><i class="fas fa-venus-mars mr-2"></i>Distribución por Género</h5>
            <div class="card border-0 bg-light">
              <div class="card-body">
                <% # Rails devuelve las claves del enum como strings en GROUP BY %>
                <% gender_names = { 'female' => 'Mujer', 'male' => 'Hombre', 'non_binary' => 'No binario', 'couple' => 'Pareja' } %>
                <% gender_icons = { 'female' => 'fas fa-venus', 'male' => 'fas fa-mars', 'non_binary' => 'fas fa-genderless', 'couple' => 'fas fa-user-friends' } %>
                <% gender_colors = { 'female' => '#ff69b4', 'male' => '#0066cc', 'non_binary' => '#9c27b0', 'couple' => '#20c997' } %>
                <% if @viewer_genders.any? %>
                  <% total_gendered = @viewer_genders.values.sum %>
                  <% @viewer_genders.each do |gender, count| %>
                    <% gender_name = gender_names[gender] || 'Sin especificar' %>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <div>
                        <i class="<%= gender_icons[gender] || 'fas fa-user' %>" style="font-size: 24px; color: <%= gender_colors[gender] || '#ccc' %>;"></i>
                        <strong class="ml-2"><%= gender_name %></strong>
                      </div>
                      <div>
                        <span class="badge badge-primary" style="font-size: 16px;"><%= count %></span>
                        <span class="text-muted small">(<%= ((count.to_f / total_gendered) * 100).round(1) %>%)</span>
                      </div>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                      <div class="progress-bar" role="progressbar" style="width: <%= (count.to_f / total_gendered) * 100 %>%; background-color: <%= gender_colors[gender] || '#6c757d' %>;" aria-valuenow="<%= count %>" aria-valuemin="0" aria-valuemax="<%= total_gendered %>"></div>
                    </div>
                  <% end %>
                <% else %>
                  <p class="text-muted text-center mb-0">Sin datos de género</p>
                <% end %>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Distribución por edad y suscripción -->
        <div class="row mb-4">
          <div class="col-md-6">
            <h5 class="mb-3"><i class="fas fa-birthday-cake mr-2"></i>Distribución por Edad</h5>
            <div class="card border-0 bg-light">
              <div class="card-body">
                <% if @age_distribution.any? %>
                  <% total_aged = @age_distribution.values.sum %>
                  <% age_order = ['< 18', '18-24', '25-34', '35-44', '45-54', '55+'] %>
                  <% age_order.each do |age_range| %>
                    <% count = @age_distribution[age_range] %>
                    <% if count.present? %>
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                          <i class="fas fa-user-circle" style="font-size: 24px; color: #6c5ce7;"></i>
                          <strong class="ml-2"><%= age_range %> años</strong>
                        </div>
                        <div>
                          <span class="badge badge-primary" style="font-size: 16px;"><%= count %></span>
                          <span class="text-muted small">(<%= ((count.to_f / total_aged) * 100).round(1) %>%)</span>
                        </div>
                      </div>
                      <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: <%= (count.to_f / total_aged) * 100 %>%;" aria-valuenow="<%= count %>" aria-valuemin="0" aria-valuemax="<%= total_aged %>"></div>
                      </div>
                    <% end %>
                  <% end %>
                <% else %>
                  <p class="text-muted text-center mb-0">Sin datos de edad</p>
                <% end %>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <h5 class="mb-3"><i class="fas fa-map-marked-alt mr-2"></i>Distribución por Geolocalización</h5>
            <div class="card border-0 bg-light">
              <div class="card-body">
                <% if @location_distribution.any? %>
                  <% total_locations = @location_distribution.values.sum %>
                  <% @location_distribution.first(10).each do |location, count| %>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                      <div>
                        <i class="fas fa-map-marker-alt" style="font-size: 24px; color: #e74c3c;"></i>
                        <strong class="ml-2"><%= location %></strong>
                      </div>
                      <div>
                        <span class="badge badge-primary" style="font-size: 16px;"><%= count %></span>
                        <span class="text-muted small">(<%= ((count.to_f / total_locations) * 100).round(1) %>%)</span>
                      </div>
                    </div>
                    <div class="progress mb-3" style="height: 8px;">
                      <div class="progress-bar bg-danger" role="progressbar" style="width: <%= (count.to_f / total_locations) * 100 %>%;" aria-valuenow="<%= count %>" aria-valuemin="0" aria-valuemax="<%= total_locations %>"></div>
                    </div>
                  <% end %>
                <% else %>
                  <p class="text-muted text-center mb-0">Sin datos de ubicación</p>
                <% end %>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Top Intereses -->
        <% if @top_interests.any? %>
          <div class="row mb-4">
            <div class="col-12">
              <h5 class="mb-3"><i class="fas fa-heart mr-2"></i>Top 10 Intereses de la Audiencia</h5>
              <div class="card border-0 bg-light">
                <div class="card-body">
                  <div class="row">
                    <% @top_interests.each_with_index do |(interest_name, user_count), index| %>
                      <div class="col-md-6 mb-3">
                        <div class="d-flex align-items-center">
                          <span class="badge badge-pill badge-primary mr-3" style="font-size: 18px; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;"><%= index + 1 %></span>
                          <div class="flex-grow-1">
                            <strong><%= interest_name %></strong>
                            <div class="progress mt-1" style="height: 6px;">
                              <div class="progress-bar bg-success" role="progressbar" style="width: <%= (user_count.to_f / @unique_viewers * 100).round(1) %>%;"></div>
                            </div>
                          </div>
                          <span class="badge badge-light ml-2"><%= user_count %> usuarios</span>
                        </div>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>
        
        <!-- Horarios de Visualización -->
        <div class="row mb-4">
          <div class="col-md-6">
            <h5 class="mb-3"><i class="fas fa-clock mr-2"></i>Distribución por Horario</h5>
            <div class="card border-0 bg-light">
              <div class="card-body">
                <% if @hourly_distribution.any? %>
                  <canvas id="hourlyChart" height="250"></canvas>
                <% else %>
                  <p class="text-muted text-center mb-0">Sin datos de horario</p>
                <% end %>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <h5 class="mb-3"><i class="fas fa-calendar-week mr-2"></i>Distribución por Día de la Semana</h5>
            <div class="card border-0 bg-light">
              <div class="card-body">
                <% if @weekday_distribution.any? %>
                  <% weekday_names = { 1 => 'Domingo', 2 => 'Lunes', 3 => 'Martes', 4 => 'Miércoles', 5 => 'Jueves', 6 => 'Viernes', 7 => 'Sábado' } %>
                  <% total_weekday = @weekday_distribution.values.sum %>
                  <% [2, 3, 4, 5, 6, 7, 1].each do |day_num| %>
                    <% count = @weekday_distribution[day_num] %>
                    <% if count.present? %>
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                          <i class="fas fa-calendar-day" style="font-size: 20px; color: #3498db;"></i>
                          <strong class="ml-2"><%= weekday_names[day_num] %></strong>
                        </div>
                        <div>
                          <span class="badge badge-primary" style="font-size: 14px;"><%= count %></span>
                          <span class="text-muted small">(<%= ((count.to_f / total_weekday) * 100).round(1) %>%)</span>
                        </div>
                      </div>
                      <div class="progress mb-2" style="height: 6px;">
                        <div class="progress-bar" role="progressbar" style="width: <%= (count.to_f / total_weekday) * 100 %>%;" aria-valuenow="<%= count %>" aria-valuemin="0" aria-valuemax="<%= total_weekday %>"></div>
                      </div>
                    <% end %>
                  <% end %>
                <% else %>
                  <p class="text-muted text-center mb-0">Sin datos de día de la semana</p>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <!-- Información adicional -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="alert alert-info mb-0">
              <h6 class="alert-heading"><i class="fas fa-info-circle mr-2"></i>Información sobre las métricas</h6>
              <hr>
              <ul class="mb-0 small">
                <li><strong>Impresiones Totales:</strong> Número total de veces que se ha mostrado esta publicidad a los usuarios.</li>
                <li><strong>Usuarios Únicos:</strong> Cantidad de usuarios diferentes que han visto la publicidad.</li>
                <li><strong>Promedio Vistas/Usuario:</strong> Número promedio de veces que cada usuario ha visto la publicidad.</li>
                <li><strong>Distribución por Plataforma:</strong> Desglose de impresiones según el sistema operativo del usuario (iOS/Android). "Desconocido" indica usuarios sin plataforma asignada.</li>
                <li><strong>Distribución por Género:</strong> Perfil demográfico de los usuarios que han visto la publicidad.</li>
                <li><strong>Distribución por Edad:</strong> Rangos etarios de los usuarios que han visualizado la publicidad.</li>
                <li><strong>Geolocalización:</strong> Principales ciudades y países de origen de los espectadores.</li>
                <li><strong>Top Intereses:</strong> Los 10 intereses más populares entre los usuarios que vieron la publicidad.</li>
                <li><strong>Horarios de Visualización:</strong> Horas del día y días de la semana con más impresiones.</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<% if @impressions_by_day.any? %>
  <script>
    let impressionsChartInstance = null;
    
    document.addEventListener('turbolinks:load', function() {
      const canvas = document.getElementById('impressionsChart');
      if (!canvas) return;
      
      // Destruir instancia anterior si existe
      if (impressionsChartInstance) {
        impressionsChartInstance.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      const impressionsData = <%= raw @impressions_by_day.to_json %>;
      const uniqueUsersData = <%= raw @unique_users_by_day.to_json %>;
      
      const labels = Object.keys(impressionsData);
      const impressionsValues = Object.values(impressionsData);
      const uniqueUsersValues = labels.map(date => uniqueUsersData[date] || 0);
      
      impressionsChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Impresiones Totales',
              data: impressionsValues,
              borderColor: 'rgb(75, 192, 192)',
              backgroundColor: 'rgba(75, 192, 192, 0.1)',
              tension: 0.3,
              fill: true,
              borderWidth: 2
            },
            {
              label: 'Usuarios Únicos',
              data: uniqueUsersValues,
              borderColor: 'rgb(255, 99, 132)',
              backgroundColor: 'rgba(255, 99, 132, 0.1)',
              tension: 0.3,
              fill: true,
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 15
              }
            },
            tooltip: {
              callbacks: {
                title: function(context) {
                  const date = new Date(context[0].label);
                  return date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
    });
  </script>
<% end %>

<script>
  let hourlyChartInstance = null;
  
  document.addEventListener('turbolinks:load', function() {
    console.log('Turbolinks loaded - initializing hourly chart');
    
    // Gráfica de distribución por horario
    const hourlyCanvas = document.getElementById('hourlyChart');
    console.log('Hourly canvas:', hourlyCanvas);
    
    if (hourlyCanvas) {
      // Destruir instancia anterior si existe
      if (hourlyChartInstance) {
        console.log('Destroying previous hourly chart instance');
        hourlyChartInstance.destroy();
      }
      
      const hourlyCtx = hourlyCanvas.getContext('2d');
      const hourlyDataRaw = <%= raw @hourly_distribution.to_json %>;
      
      console.log('Hourly data raw:', hourlyDataRaw);
      console.log('Type:', typeof hourlyDataRaw);
      console.log('Keys:', Object.keys(hourlyDataRaw));
      
      // Crear array con todas las horas del día (0-23)
      const hours = Array.from({length: 24}, (_, i) => i);
      const hourlyValues = hours.map(hour => {
        // Intentar con el número directo primero, luego como string
        const value = hourlyDataRaw[hour] !== undefined ? hourlyDataRaw[hour] : hourlyDataRaw[hour.toString()];
        console.log(`Hour ${hour}: ${value}`);
        return value || 0;
      });
      const hourLabels = hours.map(h => `${h}:00`);
      
      console.log('Final hourly values:', hourlyValues);
      
      hourlyChartInstance = new Chart(hourlyCtx, {
        type: 'bar',
        data: {
          labels: hourLabels,
          datasets: [{
            label: 'Impresiones',
            data: hourlyValues,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgb(54, 162, 235)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                title: function(context) {
                  const hour = context[0].label;
                  return `Hora: ${hour}`;
                },
                label: function(context) {
                  return `${context.parsed.y} impresiones`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                autoSkip: false,
                maxRotation: 90,
                minRotation: 45
              }
            }
          }
        }
      });
    } else {
      console.error('Hourly canvas not found!');
    }
  });
</script>

<div class="mt-4">
  <%= link_to edit_publi_path(@publi), class: 'btn btn-primary text-white', style: 'color: white !important;', :"data-turbolinks" => false do %>
    <i class="fas fa-edit"></i> Editar
  <% end %>
  <%= link_to publis_path, class: 'btn btn-secondary text-white ml-2', style: 'color: white !important;' do %>
    <i class="fas fa-arrow-left"></i> Atrás
  <% end %>
</div>
