<!-- Alert container -->
<div id="alert-container"></div>

<!-- Cards Grid -->
<div class="row">
  <!-- Formulario de env√≠o -->
  <div class="col-md-6">
    <div class="card card-primary">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-paper-plane"></i> Enviar Email de Prueba</h3>
      </div>
      <div class="card-body">
        <form id="email-form">
          <div class="form-group">
            <label for="email_type">Tipo de Email <span class="text-danger">*</span></label>
            <select class="form-control" id="email_type" name="email_type">
              <option value="test">üìß Email de Prueba Simple</option>
              <option value="welcome">üç© Email de Bienvenida (Welcome)</option>
              <!-- Aqu√≠ puedes agregar m√°s tipos de emails en el futuro -->
              <!-- <option value="password_reset">üîë Recuperaci√≥n de Contrase√±a</option> -->
              <!-- <option value="match_notification">üíù Notificaci√≥n de Match</option> -->
            </select>
            <small class="form-text text-muted">Selecciona el tipo de email que quieres probar</small>
          </div>

          <div class="form-group">
            <label for="email">Destinatario <span class="text-danger">*</span></label>
            <input 
              type="email" 
              class="form-control" 
              id="email" 
              name="email" 
              placeholder="ejemplo@gmail.com"
              required
            >
            <small class="form-text text-muted">El email donde se enviar√° la prueba</small>
          </div>

          <!-- Campos espec√≠ficos para email de bienvenida -->
          <div id="welcome-fields" style="display: none;">
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> <strong>Email de Bienvenida:</strong> Este es el email que reciben los usuarios al registrarse en Toppin.
            </div>
            
            <div class="form-group">
              <label for="name">Nombre del Usuario</label>
              <input 
                type="text" 
                class="form-control" 
                id="name" 
                name="name" 
                placeholder="Juan P√©rez"
                value="Usuario de Prueba"
              >
              <small class="form-text text-muted">El nombre que aparecer√° en el email de bienvenida</small>
            </div>
          </div>

          <!-- Campos espec√≠ficos para email de prueba simple -->
          <div id="test-fields">
            <div class="form-group">
              <label for="subject">Asunto</label>
              <input 
                type="text" 
                class="form-control" 
                id="subject" 
                name="subject" 
                placeholder="Email de prueba desde Toppin"
                value="Email de prueba desde Toppin"
              >
            </div>
            
            <div class="form-group">
              <label for="message">Mensaje</label>
              <textarea 
                class="form-control" 
                id="message" 
                name="message" 
                rows="4"
                placeholder="Escribe aqu√≠ el contenido del email..."
              >Este es un email de prueba enviado desde el panel de administraci√≥n de Toppin.</textarea>
            </div>
          </div>
          
          <button type="submit" class="btn btn-primary btn-block" id="send-btn">
            <i class="fas fa-paper-plane"></i> Enviar Email
          </button>
        </form>
        
        <div class="text-center mt-3" style="display: none;" id="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Enviando...</span>
          </div>
          <p class="mt-2">Enviando email...</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Estado de configuraci√≥n -->
  <div class="col-md-6">
    <div class="card card-info">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-cog"></i> Estado de Configuraci√≥n</h3>
      </div>
      <div class="card-body">
        <table class="table table-sm">
          <tr>
            <td><strong>API Token</strong></td>
            <td>
              <% if @config_status[:api_token] %>
                <span class="badge badge-success">‚úì Configurado</span>
              <% else %>
                <span class="badge badge-danger">‚úó No configurado</span>
              <% end %>
            </td>
          </tr>
          <tr>
            <td><strong>From Email</strong></td>
            <td>
              <% if @config_status[:from_email] %>
                <code class="text-sm"><%= ENV['MAILERSEND_FROM_EMAIL'] %></code>
              <% else %>
                <span class="badge badge-danger">‚úó No configurado</span>
              <% end %>
            </td>
          </tr>
          <tr>
            <td><strong>From Name</strong></td>
            <td>
              <% if @config_status[:from_name] %>
                <code class="text-sm"><%= ENV['MAILERSEND_FROM_NAME'] %></code>
              <% else %>
                <span class="badge badge-danger">‚úó No configurado</span>
              <% end %>
            </td>
          </tr>
          <tr>
            <td><strong>Default Host</strong></td>
            <td>
              <% if @config_status[:default_host] %>
                <code class="text-sm"><%= ENV['MAILERSEND_DEFAULT_URL_HOST'] %></code>
              <% else %>
                <span class="badge badge-danger">‚úó No configurado</span>
              <% end %>
            </td>
          </tr>
          <tr>
            <td><strong>Delivery Method</strong></td>
            <td><code class="text-sm"><%= ActionMailer::Base.delivery_method %></code></td>
          </tr>
        </table>
        
        <div class="mt-3">
          <% if @config_status.values.all? %>
            <div class="alert alert-success mb-0">
              <i class="fas fa-check-circle"></i> Configuraci√≥n completa y lista para usar
            </div>
          <% else %>
            <div class="alert alert-warning mb-0">
              <i class="fas fa-exclamation-triangle"></i> Faltan algunas configuraciones. Revisa el archivo .env
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Logs de emails -->
<div class="row">
  <div class="col-12">
    <div class="card card-success">
      <div class="card-header">
        <h3 class="card-title"><i class="fas fa-list"></i> Logs de Emails Enviados</h3>
        <div class="card-tools">
          <% if @recent_logs.any? %>
            <button class="btn btn-danger btn-sm" onclick="clearLogs()">
              <i class="fas fa-trash"></i> Limpiar Logs
            </button>
          <% end %>
        </div>
      </div>
      <div class="card-body" id="logs-container">
        <% if @recent_logs.any? %>
          <% @recent_logs.each do |log| %>
            <div class="alert <%= log[:status] == 'success' ? 'alert-success' : 'alert-danger' %>" role="alert">
              <div class="d-flex justify-content-between">
                <strong>
                  <% if log[:status] == 'success' %>
                    <i class="fas fa-check-circle"></i> Enviado
                  <% else %>
                    <i class="fas fa-times-circle"></i> Error
                  <% end %>
                </strong>
                <small class="text-muted"><%= log[:timestamp] %></small>
              </div>
              <hr class="my-2">
              <p class="mb-1"><strong>Tipo:</strong> <%= log[:email_type] || 'Email de Prueba' %></p>
              <p class="mb-1"><strong>Para:</strong> <%= log[:to] %></p>
              <p class="mb-1"><strong>Asunto:</strong> <%= log[:subject] %></p>
              <p class="mb-0"><strong>Estado:</strong> <%= log[:message] %></p>
            </div>
          <% end %>
        <% else %>
          <div class="text-center text-muted py-5">
            <i class="fas fa-inbox fa-3x mb-3"></i>
            <p>No hay logs de emails todav√≠a.</p>
            <p class="small">Los emails que env√≠es aparecer√°n aqu√≠.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  const form = document.getElementById('email-form');
  const loading = document.getElementById('loading');
  const sendBtn = document.getElementById('send-btn');
  const alertContainer = document.getElementById('alert-container');
  const logsContainer = document.getElementById('logs-container');
  const emailTypeSelect = document.getElementById('email_type');
  const welcomeFields = document.getElementById('welcome-fields');
  const testFields = document.getElementById('test-fields');
  
  // Mostrar/ocultar campos seg√∫n el tipo de email
  emailTypeSelect.addEventListener('change', (e) => {
    const emailType = e.target.value;
    
    if (emailType === 'welcome') {
      welcomeFields.style.display = 'block';
      testFields.style.display = 'none';
      sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Email de Bienvenida';
    } else if (emailType === 'test') {
      welcomeFields.style.display = 'none';
      testFields.style.display = 'block';
      sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Email de Prueba';
    }
  });
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    loading.style.display = 'block';
    sendBtn.disabled = true;
    
    try {
      const response = await fetch('/admin/mailer_test/send', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify(data)
      });
      
      const result = await response.json();
      
      if (result.success) {
        showAlert('success', result.message);
        form.reset();
        if (result.log) prependLog(result.log);
      } else {
        showAlert('error', result.error || 'Error al enviar el email');
        if (result.log) prependLog(result.log);
      }
    } catch (error) {
      showAlert('error', 'Error de conexi√≥n: ' + error.message);
    } finally {
      loading.style.display = 'none';
      sendBtn.disabled = false;
    }
  });
  
  function showAlert(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'check-circle' : 'times-circle';
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show`;
    alert.innerHTML = `
      <button type="button" class="close" data-dismiss="alert" aria-hidden="true">√ó</button>
      <h5><i class="icon fas fa-${icon}"></i> ${type === 'success' ? '√âxito' : 'Error'}</h5>
      ${message}
    `;
    
    alertContainer.innerHTML = '';
    alertContainer.appendChild(alert);
    
    setTimeout(() => {
      $(alert).fadeOut(() => alert.remove());
    }, 5000);
  }
  
  function prependLog(log) {
    const emptyState = logsContainer.querySelector('.text-center.text-muted');
    if (emptyState) emptyState.remove();
    
    const alertClass = log.status === 'success' ? 'alert-success' : 'alert-danger';
    const icon = log.status === 'success' ? 'check-circle' : 'times-circle';
    const statusText = log.status === 'success' ? 'Enviado' : 'Error';
    
    const logHtml = `
      <div class="alert ${alertClass}" role="alert">
        <div class="d-flex justify-content-between">
          <strong><i class="fas fa-${icon}"></i> ${statusText}</strong>
          <small class="text-muted">${log.timestamp}</small>
        </div>
        <hr class="my-2">
        <p class="mb-1"><strong>Tipo:</strong> ${log.email_type || 'Email de Prueba'}</p>
        <p class="mb-1"><strong>Para:</strong> ${log.to}</p>
        <p class="mb-1"><strong>Asunto:</strong> ${log.subject}</p>
        <p class="mb-0"><strong>Estado:</strong> ${log.message}</p>
      </div>
    `;
    
    logsContainer.insertAdjacentHTML('afterbegin', logHtml);
  }
  
  async function clearLogs() {
    if (!confirm('¬øEst√°s seguro de que quieres limpiar todos los logs?')) return;
    
    try {
      const response = await fetch('/admin/mailer_test/clear_logs', {
        method: 'POST',
        headers: {
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        }
      });
      
      const result = await response.json();
      
      if (result.success) {
        logsContainer.innerHTML = `
          <div class="text-center text-muted py-5">
            <i class="fas fa-inbox fa-3x mb-3"></i>
            <p>No hay logs de emails todav√≠a.</p>
            <p class="small">Los emails que env√≠es aparecer√°n aqu√≠.</p>
          </div>
        `;
        showAlert('success', 'Logs limpiados correctamente');
      }
    } catch (error) {
      showAlert('error', 'Error al limpiar los logs');
    }
  }
</script>
