<div class="row">
  <div class="col">
     <div class="card card-body">
      <p>
        <strong>Nombre:</strong>
        <%= @user.name %>
      </p>

      <p>
        <strong>Género / Edad:</strong><br>
        <%= @user.gender %><br>
        <%= @user.user_age %> años
      </p>

      <p>
        <strong>Email:</strong>
        <%= @user.email %>
        <br>
        <a href="https://dashboard.stripe.com/customers?email=<%= CGI.escape(@user.email) %>" 
           target="_blank" 
           class="btn btn-sm btn-primary mt-2">
          <i class="fab fa-stripe"></i> Ver perfil en Stripe
        </a>
      </p>

      <% if @total_purchases > 0 %>
      <div class="alert alert-success" style="margin-top: 10px;">
        <strong><i class="fas fa-shopping-cart"></i> Compras realizadas:</strong><br>
        <span style="font-size: 1.2em;"><strong><%= number_to_currency(@total_spent, unit: "€", separator: ",", delimiter: ".", format: "%n %u") %></strong></span>
        <br>
        <small>Total de <%= @total_purchases %> <%= @total_purchases == 1 ? 'compra' : 'compras' %> completadas</small>
      </div>
      <% elsif @all_purchases.any? %>
      <div class="alert alert-warning" style="margin-top: 10px;">
        <strong><i class="fas fa-info-circle"></i> Compras registradas (no completadas):</strong><br>
        <small>
          Total compras: <%= @all_purchases.count %><br>
          Estados: 
          <% @all_purchases.group(:status).count.each do |status, count| %>
            <%= status %>: <%= count %> |
          <% end %>
        </small>
      </div>
      <% else %>
      <div class="alert alert-secondary" style="margin-top: 10px;">
        <small><i class="fas fa-info-circle"></i> Este usuario aún no ha realizado compras</small>
      </div>
      <% end %>

      <p>
        <strong>Ranking:</strong>
        <%= @user.ranking %>
      </p>


      <p>
        <strong>Ubicación:</strong>
        <%= @user.location_name %>
        <div>
          <iframe
            width="400" 
            height="250" 
            style="border:0"
            loading="lazy"
            allowfullscreen
            src="https://www.google.com/maps?q=<%= @user.lat %>,<%= @user.lng %>&hl=es&z=15&output=embed">
          </iframe>
        </div>
      </p>



      <p>
        <strong>Admin:</strong>
        <%= true_false(@user.admin) %>
      </p>


      <% if @user.is_premium %>
      <p class="alert alert-warning">
        <strong>Suscripción:</strong>
        <%= @user.current_subscription_id %> / <%= @user.current_subscription_name %>
      </p>
      <% end %>



      <p>
        <strong>Descripción:</strong>
        <%= @user.description %>
      </p>


      <p>
        <strong>Intereses:</strong>
        <% @user.user_interests.each do |interest| %>
          <span class="badge badge-success" style="padding: 5px;"><%= interest.interest_name %></span>
        <% end %>
      </p>

      <p>
        <strong>Intereses principales:</strong>
        <% @user.user_main_interests.each do |main_interest| %>
          <span class="badge badge-primary" style="padding: 5px;"><%= main_interest.name %> - <%= main_interest.percentage %> %</span>
        <% end %>
      </p>

      <p>
        <strong>Perfil:</strong>
        <% @user.user_info_item_values.each do |value| %>
          <span class="badge badge-info" style="padding: 5px;"><%= value.category_name %>: <%= value.item_name %></span>
        <% end %>
      </p>


      <div style="background: white; padding: 2%; border: 1px solid #eee;">
        <h5>Preferencias de búsqueda: </h5>
          <b>Buscando: </b><%= @user.user_filter_preference&.gender_preferences %><br>
          <b>Edad: </b> <%= @user.user_filter_preference&.age_from %> a  <%= @user.user_filter_preference&.age_till %><br>
          <b>Max:</b> <%= @user.user_filter_preference&.distance_range %>km <br>
          <b>Intereses: </b>
          <% @interests.each do |interest| %>
            <span class="badge badge-success" style="padding: 5px;">#<%= interest.name %> </span>
          <% end %>
          <br>

          <b>Otras preferencias: </b>
          <% @categories.each do |category| %>
            <span class="badge badge-info" style="padding: 5px;"><%= category.info_item_category.name %>: <%= category.value %> </span>
          <% end %>

      </div>

      <hr>

      <p>
        <strong>Superlikes disponibles:</strong>
        <%= @user.superlike_available %>, último: <%= @user.last_superlike_given.strftime("%d-%m-%Y a las %H:%M") if  @user.last_superlike_given %>
      </p>

      <p>
        <strong>Boosts:</strong>
        <%= @user.boost_available %>
      </p>

      <p>
        <strong>Registrado:</strong>
        <%= @user.created_at.strftime("%d-%m-%Y a las %H:%M") %>
      </p>

      <%= link_to 'Spotify Data', user_admin_spotify_user_data_path(@user), class: 'btn btn-success' %>


    </div>

  </div>
  <div class="col">

   <div style="padding: 2%; background: white;">
    <% if @user.verification_image.present? %>
    <div style="background:  white; padding: 2%; border: 1px solid #ccc; ">
       <b> Imagen de verificación: </b><br>
        <%= image_tag @user.verification_image.thumb.url, style: 'max-height: 120px; max-width: 250px;' if @user.verification_image? %>
    </div>

    <hr>
    <% end %>



    <% @user.user_media.each do |media| %>
      <% if media.file.present? %>
        <%= image_tag media.file.thumb.url, style: 'max-height: 450px; max-width: 200px;' if media.file %>
      <% end %>
    <% end %>

     </div>
  </div>

</div>

<hr>

<div class="row">
  <div class="col">


<div class="card">
  <div class="card-header bg-dark" style="display: flex; justify-content: space-between; align-items: center;">
    <span><b>Matches (<%= @matches.count %>)</b></span>
    <% if @matches.any? %>
      <%= link_to clear_all_matches_path(user_id: @user.id), 
          method: :post,
          data: { confirm: "¿Estás seguro de que quieres eliminar TODOS los matches (#{@matches.count}) de este usuario? Esta acción no se puede deshacer y se eliminarán todas las conversaciones de Twilio." },
          class: 'btn btn-danger btn-sm',
          style: 'margin-left: auto;' do %>
        <i class="fas fa-trash-alt"></i> Limpiar todos
      <% end %>
    <% end %>
  </div>
  <div class="card-body">

    <table class="table">

      <thead>
        <th></th>
        <th>Usuario</th>
        <th>Es superlike</th>
        <th>Ranking</th>
        <th>Fecha match</th>
        <th> </th>
      </thead>


     <% @matches.each do |match_request| %>
      <tr>
        <td>
          <% if match_request.target && match_request.target.id != @user.id && match_request.target.profile_picture_thumb.present? %>
          <%= image_tag match_request.target.profile_picture_thumb, class: 'img-thumbnail', style: 'height: 70px;' %>
            <% end %>

          <% if match_request.user && match_request.user.id != @user.id && match_request.user.profile_picture_thumb.present? %>
          <%= image_tag match_request.user.profile_picture_thumb, class: 'img-thumbnail', style: 'height: 70px;' %>
            <% end %>
          </td>
        <td>
          <%= link_to match_request.target.name, show_user_path(id: match_request.target.id) if match_request.target and match_request.target.id != @user.id %>
          <%= link_to match_request.user.name, show_user_path(id: match_request.user.id) if match_request.user and match_request.user.id != @user.id %>
        </td>
        <td><%= true_false(match_request.is_superlike) %></td>
        <td><%= match_request.target_user_ranking %></td>
        <td><%= match_request.created_at.strftime("%d-%m-%Y a las %H:%M") %></td>
        <td>
          <button class="btn btn-sm btn-primary chat disabled"
            id="<%= match_request.twilio_conversation_sid %>"
            data-sid="<%= match_request.twilio_conversation_sid %>">
            <i class="fas fa-comments"></i>
            Ver Chat
          </button>
          
          <% 
            # Determinar el target_user_id correcto
            other_user_id = match_request.target.id != @user.id ? match_request.target.id : match_request.user.id
          %>
          
          <%= link_to unmatch_path(user_id: @user.id, target_user: other_user_id), 
              method: :post,
              data: { confirm: '¿Estás seguro de que quieres deshacer este match? Se eliminará la conversación de Twilio.' },
              class: 'btn btn-sm btn-danger' do %>
            <i class="fas fa-times"></i> Deshacer
          <% end %>
        </td>
      </tr>
     <% end %>


    </table>

    <hr>

    <div style="background: #eee; padding: 5px; display: flex; justify-content: space-between; align-items: center;">
      <span><b><i class="fa fa-heart"></i> Likes (<%= @likes.count %>)</b></span>
      <% if @likes.any? %>
        <div>
          <%= link_to match_all_likes_path(user_id: @user.id), 
              method: :post,
              data: { confirm: "¿Estás seguro de que quieres hacer match con TODOS los likes (#{@likes.count})?" },
              class: 'btn btn-success btn-sm',
              style: 'margin-right: 5px;' do %>
            <i class="fas fa-check-double"></i> Match con todos
          <% end %>
          
          <%= link_to reject_all_likes_path(user_id: @user.id), 
              method: :post,
              data: { confirm: "¿Estás seguro de que quieres rechazar TODOS los likes (#{@likes.count})?" },
              class: 'btn btn-danger btn-sm' do %>
            <i class="fas fa-times-circle"></i> Rechazar todos
          <% end %>
        </div>
      <% end %>
    </div>


    <table class="table">

      <thead>
        <th></th>
        <th>Usuario</th>
        <th>Es superlike</th>
        <th>Fecha</th>
        <th> </th>
      </thead>


     <% @likes.each do |match_request| %>
      <tr>
        <td></td>
        <td>
          <%= match_request.target.name if match_request.target.id != @user.id %>
          <%= match_request.user.name if match_request.user.id != @user.id %>
        </td>
        <td><%= true_false(match_request.is_superlike) %></td>
        <td><%= match_request.target_user_ranking %></td>
        <td><%= match_request.created_at.strftime("%d-%m-%Y a las %H:%M") %></td>
        <td>
          <%= link_to 'Hacer match', create_match_path(id: match_request.id), class: 'btn btn-success btn-sm text-white' %>
          
          <%= link_to reject_incoming_like_path(user_id: @user.id, like_id: match_request.id), 
              method: :post,
              data: { confirm: '¿Estás seguro de que quieres rechazar este like?' },
              class: 'btn btn-danger btn-sm',
              style: 'margin-left: 5px;' do %>
            <i class="fas fa-times"></i>
          <% end %>
        </td>
     <% end %>

    </table>

    <hr>

    <p style="background:  #eee; padding:5px;"><b><i class="fa fa-heart-o"></i> Likes dados (<%= @sent_likes.total_entries %>)</b></p>

    <div id="sent-likes-container">
      <%= render 'sent_likes' %>
    </div>

    <hr>
    <p style="background:  #eee; padding:5px;"><b><i class="fa fa-heart"></i> Dar un like</b></p>

    <%= form_with url: "/create_like",local: true do |form| %>

       <%= collection_select(nil,:target_user, @users, :id, :id_with_name, {}, {class: 'form-control selectpicker', "data-live-search" => "true", style: "height: 300px;"}) %>
       <%= hidden_field nil, :user_id, value: @user.id %>

        <%= form.submit "Enviar like", class: 'btn btn-success btn-sm btn-block mt-2' %>
    <% end %>

  </div>
</div>


  </div>
  <div class="col">

    <div class="card">
      <div class="card-header bg-dark"><b>Chat</b></div>

      <!-- Título del chat -->
      <div id="chat-title" style="padding: 8px; font-weight: bold;"></div>

      <!-- Botón de actualización de conversación -->
      <div style="margin: 0 8px 10px 8px;">
        <button id="refresh-chat" class="btn btn-success btn-sm">Actualizar conversación</button>
      </div>

      <!-- Cuerpo del chat -->
      <div class="card-body" id="conversation" style="max-height: 400px; min-height: 400px; overflow: scroll"></div>

      <!-- Input de mensaje -->
      <div class="card-footer">
        <input type="text" id="message" class="form-control" placeholder="Chatea">
      </div>
    </div>


  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
  let currentSid = null;
  const fichaUserId = <%= @user.id %>; // <-- El id del usuario de la ficha

  // Inicializa los botones de chat
  document.querySelectorAll('.btn.chat').forEach(function(btn) {
    btn.classList.remove('disabled');
    btn.addEventListener('click', function() {
      // Obtener nombre de usuario
      const row = btn.closest('tr');
      let userName = '';
      if (row) {
        const userCell = row.querySelector('td:nth-child(2)');
        if (userCell) {
          userName = userCell.textContent.trim();
        }
      }
      document.getElementById('chat-title').textContent = userName ? `Conversación con: ${userName}` : '';

      // Obtener SID
      currentSid = btn.getAttribute('data-sid');
      cargarMensajes(currentSid);
    });
  });

  // Función para cargar mensajes
  function cargarMensajes(sid) {
    if (!sid) return;

    fetch(`/admin/conversation_messages/${sid}`)
      .then(response => response.json())
      .then(messages => {
        let html = '';
        if (messages.length === 0) {
          html = '<p class="text-muted">No hay mensajes en esta conversación.</p>';
        } else {
          messages.forEach(msg => {
            const isFichaUser = parseInt(msg.author_id) === fichaUserId;
            html += `
              <div class="${isFichaUser ? "chatContainerAuthor" : "" }">
                <div class="${isFichaUser ? "chatUser1" : "chatUser2" }" style="margin-bottom:8px;">
                  <b>${msg.author}:</b> ${msg.body}
                  <br><small class="text-muted">${msg.date_created}</small>
                </div>
              </div>
            `;
          });
        }
        document.getElementById('conversation').innerHTML = html;
      });
  }

  // Evento para el botón de "Actualizar conversación"
  document.getElementById('refresh-chat')?.addEventListener('click', function() {
    if (currentSid) {
      cargarMensajes(currentSid);
    } else {
      alert('Primero selecciona una conversación.');
    }
  });

  // Paginación AJAX para "Likes dados"
  document.addEventListener('click', function(e) {
    const paginationLink = e.target.closest('#sent-likes-container .pagination a');
    if (paginationLink) {
      e.preventDefault();
      
      const url = paginationLink.href;
      
      // Mostrar loading
      const container = document.getElementById('sent-likes-container');
      const originalOpacity = container.style.opacity;
      container.style.opacity = '0.5';
      container.style.pointerEvents = 'none';
      
      fetch(url, {
        headers: {
          'Accept': 'text/html'
        }
      })
      .then(response => response.text())
      .then(html => {
        // Crear un elemento temporal para parsear el HTML
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Extraer solo el contenido del container de sent-likes
        const newContent = doc.querySelector('#sent-likes-container');
        if (newContent) {
          container.innerHTML = newContent.innerHTML;
        } else {
          // Si no encuentra el container, busca el partial directamente
          const table = doc.querySelector('table');
          const pagination = doc.querySelector('.pagination');
          if (table) {
            container.innerHTML = '';
            container.appendChild(table.cloneNode(true));
            if (pagination) {
              const paginationDiv = document.createElement('div');
              paginationDiv.className = 'text-center';
              paginationDiv.appendChild(pagination.cloneNode(true));
              container.appendChild(paginationDiv);
            }
          }
        }
        
        container.style.opacity = '1';
        container.style.pointerEvents = 'auto';
        
        // Scroll suave a la sección
        const header = container.previousElementSibling;
        if (header) {
          header.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      })
      .catch(error => {
        console.error('Error:', error);
        container.style.opacity = originalOpacity || '1';
        container.style.pointerEvents = 'auto';
        alert('Error al cargar la página');
      });
    }
  });
});
</script>

<%= link_to 'Atrás', users_path %>
