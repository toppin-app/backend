
<%= form_for :user, url: @route do |f| %>

	<% if @edit %>
	<div class="field" hidden>
	     <%= f.label "Email" %>
	    <%= f.text_field :id , value: @user.id%>
	  </div>
	<% end %>

  <div class="field">
     <%= f.label "Email" %>
    <%= f.email_field :email, autofocus: true, value: @user.email, autocomplete: "email", class: 'form-control' %>
  </div>

  <div class="field">
     <%= f.label "Nombre" %>
    <%= f.text_field :name, autofocus: true, value: @user.name, class: 'form-control' %>
  </div>


  <div class="field">
     <%= f.label "G√©nero" %>

     <%= f.select :gender, [['Hombre', "male"], ['Mujer', "female"],['Pareja', "couple"], ['Otros', "gender_any"]]%>



  </div>

  <div class="field">
     <%= f.label "Fecha nacimiento" %>
    <%= f.date_field :birthday, value: @user.birthday, class: 'form-control' %>
  </div>

  <div class="field">
     <%= f.label "Lugar nacimiento" %>
    <%= f.text_field :born_in, autofocus: true, value: @user.born_in, class: 'form-control' %>
  </div>


  <div class="field">
     <%= f.label "Vive en" %>
    <%= f.text_field :living_in, autofocus: true, value: @user.living_in, class: 'form-control' %>
  </div>

  <hr>

  <h5>üìç Geolocalizaci√≥n <small class="text-muted">(Para que aparezca en swipes)</small></h5>
  
  <div class="card card-body" style="margin-bottom: 20px;">
    <p><small><i>Establece la ubicaci√≥n GPS del usuario. Esto es necesario para que aparezca en los swipes de otros usuarios.</i></small></p>
    
    <div class="alert alert-info" style="padding: 10px; margin-bottom: 15px;">
      <strong>Ubicaciones r√°pidas:</strong> 
      <a href="#" onclick="setValenciaLocation(); return false;" class="badge badge-primary">Valencia</a>
      <a href="#" onclick="setMadridLocation(); return false;" class="badge badge-primary">Madrid</a>
      <a href="#" onclick="setBarcelonaLocation(); return false;" class="badge badge-primary">Barcelona</a>
      <a href="#" onclick="setSevillaLocation(); return false;" class="badge badge-primary">Sevilla</a>
      <a href="#" onclick="setBilbaoLocation(); return false;" class="badge badge-primary">Bilbao</a>
      <a href="#" onclick="setMalagaLocation(); return false;" class="badge badge-primary">M√°laga</a>
    </div>
    
    <div class="row">
      <div class="col-md-6">
        <div class="field">
          <label><strong>Latitud</strong></label>
          <%= f.text_field :lat, value: @user.lat, class: 'form-control', placeholder: 'Ej: 39.4699', id: 'user_lat' %>
          <small class="form-text text-muted">Puedes obtenerla en <a href="https://www.google.com/maps" target="_blank">Google Maps</a> haciendo clic derecho</small>
        </div>
      </div>
      <div class="col-md-6">
        <div class="field">
          <label><strong>Longitud</strong></label>
          <%= f.text_field :lng, value: @user.lng, class: 'form-control', placeholder: 'Ej: -0.3763', id: 'user_lng' %>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top: 15px;">
      <div class="col-md-6">
        <div class="field">
          <label><strong>Ciudad</strong></label>
          <%= f.text_field :location_city, value: @user.location_city, class: 'form-control', placeholder: 'Ej: Valencia', id: 'user_location_city' %>
        </div>
      </div>
      <div class="col-md-6">
        <div class="field">
          <label><strong>Pa√≠s</strong></label>
          <%= f.text_field :location_country, value: @user.location_country, class: 'form-control', placeholder: 'Ej: Espa√±a', id: 'user_location_country' %>
        </div>
      </div>
    </div>

    <% if @user.lat.present? && @user.lng.present? %>
      <div style="margin-top: 15px;">
        <strong>Vista previa del mapa:</strong>
        <iframe
          width="100%" 
          height="250" 
          style="border:0; border-radius: 5px; margin-top: 10px;"
          loading="lazy"
          allowfullscreen
          src="https://www.google.com/maps?q=<%= @user.lat %>,<%= @user.lng %>&hl=es&z=13&output=embed">
        </iframe>
      </div>
    <% end %>

    <script>
      function setLocation(lat, lng, city, country) {
        document.getElementById('user_lat').value = lat;
        document.getElementById('user_lng').value = lng;
        document.getElementById('user_location_city').value = city;
        document.getElementById('user_location_country').value = country;
      }
      
      function setValenciaLocation() {
        setLocation('39.4699', '-0.3763', 'Valencia', 'Espa√±a');
      }
      
      function setMadridLocation() {
        setLocation('40.4168', '-3.7038', 'Madrid', 'Espa√±a');
      }
      
      function setBarcelonaLocation() {
        setLocation('41.3851', '2.1734', 'Barcelona', 'Espa√±a');
      }
      
      function setSevillaLocation() {
        setLocation('37.3891', '-5.9845', 'Sevilla', 'Espa√±a');
      }
      
      function setBilbaoLocation() {
        setLocation('43.2630', '-2.9350', 'Bilbao', 'Espa√±a');
      }
      
      function setMalagaLocation() {
        setLocation('36.7213', '-4.4214', 'M√°laga', 'Espa√±a');
      }
    </script>
  </div>

  <hr>


  <div class="field">
     <%= f.label "Descripci√≥n" %>
    <%= f.text_area :description, autofocus: true, value: @user.description, rows: 4, class: 'form-control' %>
  </div>


 <div class="card card-body">
  <div class="field">
      <% if @edit %>
        <% if @images.any? %>
          <p>Click sobre la imagen para eliminar. </p>
        <% end %>
        <% @images.each do |i| %>

          <% begin %>
            <%= link_to i, method: :delete, data: { confirm: '¬øEliminar?' } do %>
              <% if i.file.present? %>
                <%= image_tag i.file.thumb.url, style: 'max-height: 80px;' %>
              <% else %>
                <i class="far fa-file-image fa-6x" style="color: #65a4e6;"></i>
              <% end %>
            <% end %>
          <% rescue => e %>
            <p>Error al acceder a la imagen: <%= e.message %></p>
          <% end %>

        <% end %>
      <% end %>
      <%= f.label "Im√°genes" %>
      <%= f.file_field :images, multiple: true %>
   </div>
</div>


    <% if @edit %>
     <div style="padding: 10px;">
      <% @user.user_info_item_values.each do |iv| %>
        <span class="badge badge-info" style="margin: 3px;"><%= iv.category_name %>: <%= iv.item_name %>

          -- <%= link_to 'Eliminar', iv, method: :delete, data: { confirm: '¬øEliminar?' } %>
        </span>
      <% end %>
    </div>
    <% end %>


   <div class="card card-body">
    <b>Perfil</b>

      <div class="field">
         <%= collection_select(nil,:info_item_values, InfoItemValue.where.not(id: @user.user_info_item_values.pluck(:info_item_value_id)), :id, :name_with_category, {}, {:multiple => true, class: 'form-control selectpicker', "data-live-search" => "true", style: "height: 300px;"}) %>
      </div>
   </div>



    <hr>

    <h5>üé¨ Pel√≠culas Favoritas (TMDB)</h5>

    <% if @edit && @user.tmdb_user_data.any? %>
      <div style="padding: 10px; margin-bottom: 10px; background-color: #f8f9fa; border-radius: 5px;">
        <strong>Pel√≠culas actuales:</strong><br>
        <% @user.tmdb_user_data.each do |movie| %>
          <div style="display: inline-block; margin: 5px;">
            <span class="badge badge-success" style="font-size: 14px; padding: 8px; display: block;">
              <%= movie.title %>
              <% if movie.poster_path.present? %>
                <br><small>ID: <%= movie.tmdb_id %></small>
              <% end %>
            </span>
            <%= link_to 'üóëÔ∏è Eliminar', tmdb_user_datum_path(movie), method: :delete, data: { confirm: '¬øEliminar pel√≠cula?' }, class: 'btn btn-sm btn-danger', style: 'margin-top: 5px;' %>
          </div>
        <% end %>
      </div>
    <% end %>

    <div class="card card-body" style="margin-bottom: 20px;">
      <div class="alert alert-info" style="padding: 10px; margin-bottom: 15px;">
        <i class="fa fa-lightbulb"></i> <strong>¬øC√≥mo encontrar el ID de TMDB?</strong>
        <ol style="margin: 5px 0 0 20px; font-size: 13px;">
          <li>Ve a <a href="https://www.themoviedb.org/" target="_blank">themoviedb.org</a></li>
          <li>Busca la pel√≠cula que quieres a√±adir</li>
          <li>El ID est√° en la URL: themoviedb.org/movie/<strong>ID</strong>/nombre-pelicula</li>
          <li>El poster_path lo encuentras en la p√°gina de la pel√≠cula, termina en .jpg</li>
        </ol>
      </div>
      
      <p><small><i>A√±ade hasta 3 pel√≠culas. Deja los campos vac√≠os si no quieres a√±adir todas.</i></small></p>
      
      <div id="movies-container">
        <% 3.times do |i| %>
          <div class="row" style="margin-bottom: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
            <div class="col-md-12" style="margin-bottom: 5px;"><strong>Pel√≠cula #<%= i + 1 %></strong></div>
            <div class="col-md-2">
              <label><small>TMDB ID</small></label>
              <%= number_field_tag "movie_#{i}_tmdb_id", nil, 
                  { placeholder: "Ej: 550", class: 'form-control', min: 1 } %>
            </div>
            <div class="col-md-5">
              <label><small>T√≠tulo</small></label>
              <%= text_field_tag "movie_#{i}_title", nil, 
                  { placeholder: "Ej: Fight Club", class: 'form-control' } %>
            </div>
            <div class="col-md-5">
              <label><small>Poster Path</small></label>
              <%= text_field_tag "movie_#{i}_poster_path", nil, 
                  { placeholder: "Ej: /pB8BM7pdSp6B6Ih7QZ4DrQ3PmJK.jpg", class: 'form-control' } %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <hr>

    <h5>üì∫ Series Favoritas (TMDB)</h5>

    <% if @edit && @user.tmdb_user_series_data.any? %>
      <div style="padding: 10px; margin-bottom: 10px; background-color: #f8f9fa; border-radius: 5px;">
        <strong>Series actuales:</strong><br>
        <% @user.tmdb_user_series_data.each do |series| %>
          <div style="display: inline-block; margin: 5px;">
            <span class="badge badge-info" style="font-size: 14px; padding: 8px; display: block;">
              <%= series.title %>
              <% if series.poster_path.present? %>
                <br><small>ID: <%= series.tmdb_id %></small>
              <% end %>
            </span>
            <%= link_to 'üóëÔ∏è Eliminar', tmdb_user_series_datum_path(series), method: :delete, data: { confirm: '¬øEliminar serie?' }, class: 'btn btn-sm btn-danger', style: 'margin-top: 5px;' %>
          </div>
        <% end %>
      </div>
    <% end %>

    <div class="card card-body" style="margin-bottom: 20px;">
      <div class="alert alert-info" style="padding: 10px; margin-bottom: 15px;">
        <i class="fa fa-lightbulb"></i> <strong>¬øC√≥mo encontrar el ID de TMDB para series?</strong>
        <ol style="margin: 5px 0 0 20px; font-size: 13px;">
          <li>Ve a <a href="https://www.themoviedb.org/" target="_blank">themoviedb.org</a></li>
          <li>Busca la serie que quieres a√±adir</li>
          <li>El ID est√° en la URL: themoviedb.org/tv/<strong>ID</strong>/nombre-serie</li>
          <li>El poster_path lo encuentras en la p√°gina de la serie</li>
        </ol>
      </div>
      
      <p><small><i>A√±ade hasta 3 series. Deja los campos vac√≠os si no quieres a√±adir todas.</i></small></p>
      
      <div id="series-container">
        <% 3.times do |i| %>
          <div class="row" style="margin-bottom: 15px; padding: 10px; background-color: #f9f9f9; border-radius: 5px;">
            <div class="col-md-12" style="margin-bottom: 5px;"><strong>Serie #<%= i + 1 %></strong></div>
            <div class="col-md-2">
              <label><small>TMDB ID</small></label>
              <%= number_field_tag "series_#{i}_tmdb_id", nil, 
                  { placeholder: "Ej: 1396", class: 'form-control', min: 1 } %>
            </div>
            <div class="col-md-5">
              <label><small>T√≠tulo</small></label>
              <%= text_field_tag "series_#{i}_title", nil, 
                  { placeholder: "Ej: Breaking Bad", class: 'form-control' } %>
            </div>
            <div class="col-md-5">
              <label><small>Poster Path</small></label>
              <%= text_field_tag "series_#{i}_poster_path", nil, 
                  { placeholder: "Ej: /ggFHVNu6YYI5L9pCfOacjizRGt.jpg", class: 'form-control' } %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <hr>

    <h5>Preferencias de B√∫squeda</h5>

    <div class="card card-body" style="margin-bottom: 20px;">
      <div class="field"><b>Buscando: </b>
        <%= select nil, :filter_gender, options_for_select([['Hombre', 'male'], ['Mujer', 'female'], ['Todos', 'gender_any'], ['Pareja', 'couple']], @user.user_filter_preference&.gender_preferences), {}, {class: 'form-control'} %>
      </div>

      <div class="field">
        <b>Hasta km</b>
        <%= text_field nil, :distance_range, value: @user.user_filter_preference&.distance_range, class: 'form-control', placeholder: 'Ej: 50' %>
      </div>
    </div>

    <hr>

    <h5>Intereses Principales <span class="badge badge-info">Obligatorio: 4 intereses</span></h5>

    <% if @edit && @user.user_main_interests.any? %>
      <div style="padding: 10px; margin-bottom: 10px; background-color: #f8f9fa; border-radius: 5px;">
        <strong>Intereses actuales:</strong><br>
        <% @user.user_main_interests.each do |mi| %>
          <span class="badge badge-primary" style="margin: 3px; font-size: 14px; padding: 8px;">
            <%= mi.name %> - <%= mi.percentage %>%
          </span>
        <% end %>
      </div>
    <% end %>

    <div class="card card-body" style="margin-bottom: 20px;">
      <p><small><i>Selecciona exactamente 4 intereses principales. Cada inter√©s tiene un porcentaje de afinidad (0-100%)</i></small></p>
      
      <div id="main-interests-container">
        <% 
          existing_main = @edit ? @user.user_main_interests.to_a : []
          4.times do |i| 
            current_main = existing_main[i]
        %>
          <div class="row" style="margin-bottom: 10px;">
            <div class="col-md-1" style="padding-top: 8px;">
              <strong>#<%= i + 1 %></strong>
            </div>
            <div class="col-md-7">
              <%= select_tag "main_interest_#{i}_id", 
                  options_from_collection_for_select(Interest.all.order(:name), :id, :name, current_main&.interest_id), 
                  { include_blank: "Selecciona un inter√©s", class: 'form-control' } %>
            </div>
            <div class="col-md-4">
              <div class="input-group">
                <%= number_field_tag "main_interest_#{i}_percentage", current_main&.percentage, 
                    { placeholder: "0-100", class: 'form-control', min: 0, max: 100 } %>
                <div class="input-group-append">
                  <span class="input-group-text">%</span>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <hr>

    <h5>Intereses Adicionales</h5>

    <% if @edit %>
      <div style="padding: 10px;">
        <% @user.user_interests.each do |i| %>
          <span class="badge badge-warning" style="margin: 3px;"><%= i.interest.interest_category.name %>: <%= i.interest.name %>

            -- <%= link_to 'Eliminar', i, method: :delete, data: { confirm: '¬øEliminar?' } %>
          </span>
        <% end %>
      </div>
    <% end %>

   <div class="card card-body">

      <div class="field">
         <%= f.label "A√±adir intereses" %>
        <%= collection_select(nil,:user_interests, Interest.where.not(id: @user.user_interests.pluck(:interest_id)), :id, :name, {}, {:multiple => true, class: 'form-control selectpicker', "data-live-search" => "true", style: "height: 300px;"}) %>
      </div>
   </div>



  <div class="field">
    <%= f.label "Contrase√±a" %>   <% if @edit %> <i>(Para mantener la contrase√±a actual mantener en blanco este campo)</i><br /> <% end %>
    <%= f.password_field :password, autocomplete: "new-password", class: 'form-control' %>
    <% if @minimum_password_length %>
      <br />
      <em><%= @minimum_password_length %> caracteres m√≠nimo</em>
    <% end %>
  </div>

  <div class="field">
    <%= f.label "Confirmar contrase√±a" %><br />
    <%= f.password_field :password_confirmation, autocomplete: "new-password", class: 'form-control' %>
  </div>

<!--
  <div class="field">
    <%= f.label "Contrase√±a actual" %> <i>(Necesitamos la contrase√±a actual para confirma tus cambios)</i><br />
    <%= f.password_field :current_password, autocomplete: "current-password", class: 'form-control' %>
  </div>
-->

  <div class="field">
    <p><%= f.check_box :verified, checked: @user.verified %>
    <b>Verificado</b></p>
  </div>




  <div class="field">
    <p><%= f.check_box :admin, checked: @user.admin %>
    <b>Administrador</b></p>
  </div>


    <div class="field">
    <b>Suscripci√≥n</b>
    <%= f.text_field :current_subscription_name,value: @user.current_subscription_name, class: 'form-control' %>
  </div>


    <div class="field">
    <b>ID suscripci√≥n</b>
    <%= f.text_field :current_subscription_id,value: @user.current_subscription_id, class: 'form-control' %>
  </div>



  <div class="actions">
    <%= button_tag type: 'submit', class: "btn btn-success", style: 'width: 160px; font-size: 12px' do %>
        <i class="fa fa-check" aria-hidden="true"></i> Guardar datos
    <% end %>
  </div>
<% end %>
