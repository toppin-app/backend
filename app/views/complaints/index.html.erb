<style>
  .complaints-table {
    font-size: 13px;
  }
  
  .complaints-table td, .complaints-table th {
    vertical-align: middle;
  }
  
  .complaints-table .col-user {
    min-width: 180px;
  }
  
  .complaints-table .col-reason {
    width: 120px;
  }
  
  .complaints-table .col-text {
    min-width: 200px;
    max-width: 300px;
  }
  
  .complaints-table .col-date {
    width: 140px;
    font-size: 12px;
    color: #666;
  }
  
  .complaints-table .col-actions {
    width: 80px;
    text-align: center;
  }
  
  .btn-action {
    padding: 4px 8px;
    font-size: 12px;
  }
  
  .user-card {
    cursor: pointer;
    transition: all 0.2s;
    padding: 8px;
    border-radius: 4px;
  }
  
  .user-card:hover {
    background-color: #f8f9fa;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .user-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 2px;
  }
  
  .user-email {
    font-size: 11px;
    color: #7f8c8d;
  }
  
  .user-id {
    font-size: 10px;
    color: #95a5a6;
    font-family: monospace;
  }
  
  .reason-badge {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: 500;
  }
  
  .filter-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    color: white;
  }
  
  .filter-section h4 {
    margin: 0 0 15px 0;
    font-size: 18px;
  }
  
  .stats-row {
    display: flex;
    gap: 20px;
    margin-top: 10px;
  }
  
  .stat-item {
    background: rgba(255,255,255,0.2);
    padding: 10px 15px;
    border-radius: 6px;
    flex: 1;
  }
  
  .stat-label {
    font-size: 11px;
    opacity: 0.9;
  }
  
  .stat-value {
    font-size: 20px;
    font-weight: bold;
  }
</style>

<!-- Modales de éxito y error -->
<div class="modal fade" id="successModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="fas fa-check-circle"></i> Acción exitosa</h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="successMessage">La acción se completó correctamente.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-dismiss="modal" onclick="location.reload()">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="errorModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Error</h5>
        <button type="button" class="close text-white" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="errorMessage">Hubo un error al procesar la acción.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Manejar envío de formularios de acción
  document.querySelectorAll('.complaint-action-form').forEach(function(form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(form);
      const action = form.action;
      const actionType = formData.get('complaint[action_taken]');
      
      // Cerrar modal de confirmación
      const modalId = form.closest('.modal').id;
      $('#' + modalId).modal('hide');
      
      // Enviar formulario vía AJAX
      fetch(action, {
        method: 'PATCH',
        body: formData,
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          let message = '';
          if (actionType === 'user_blocked') {
            message = 'Usuario bloqueado correctamente. La denuncia ha sido marcada como revisada.';
          } else if (actionType === 'invalidated') {
            message = 'Denuncia ignorada correctamente. La denuncia ha sido marcada como revisada.';
          }
          document.getElementById('successMessage').textContent = message;
          $('#successModal').modal('show');
        } else {
          document.getElementById('errorMessage').textContent = data.error || 'Hubo un error al procesar la acción.';
          $('#errorModal').modal('show');
        }
      })
      .catch(error => {
        document.getElementById('errorMessage').textContent = 'Error de conexión. Por favor, intenta nuevamente.';
        $('#errorModal').modal('show');
      });
    });
  });
});
</script>

<div class="filter-section">
  <h4><i class="fas fa-exclamation-triangle"></i> Gestión de Denuncias</h4>
  
  <%= form_tag complaints_path, method: :get, class: 'form-inline' do %>
    <div class="form-group mr-3">
      <label class="mr-2">Filtrar por razón:</label>
      <%= select_tag :reason, 
          options_for_select([['Todas las razones', '']] + @reasons.map { |r| [r, r] }, params[:reason]),
          class: 'form-control form-control-sm',
          onchange: 'this.form.submit()' %>
    </div>
  <% end %>
  
  <div class="stats-row">
    <div class="stat-item">
      <div class="stat-label">Total Denuncias</div>
      <div class="stat-value"><%= @complaints.count %></div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Usuarios Únicos Denunciados</div>
      <div class="stat-value"><%= @complaints.map(&:to_user_id).uniq.count %></div>
    </div>
  </div>
</div>

<div class="card card-body">
  <div class="table-responsive">
    <table class="table table-striped table-sm complaints-table">
      <thead>
        <tr>
          <th class="col-user">Denunciante</th>
          <th class="col-user">Denunciado</th>
          <th class="col-reason">Razón</th>
          <th class="col-date">Fecha</th>
          <th class="col-actions">Estado</th>
          <th class="col-actions">Acciones</th>
          <th class="col-actions">Eliminar</th>
        </tr>
      </thead>

      <tbody>
        <% @complaints.each do |complaint| %>
          <tr>
            <td class="col-user">
              <div class="user-card" data-toggle="modal" data-target="#userModal<%= complaint.user_id %>" title="Ver perfil completo">
                <div class="user-name"><i class="fas fa-user"></i> <%= complaint.user.name %></div>
                <div class="user-email"><i class="fas fa-envelope"></i> <%= complaint.user.email %></div>
                <div class="user-id">ID: <%= complaint.user_id %></div>
              </div>
            </td>
            
            <td class="col-user">
              <% if complaint.reported_user.present? %>
                <div class="user-card" data-toggle="modal" data-target="#reportedUserModal<%= complaint.to_user_id %>" title="Ver perfil completo">
                  <div class="user-name"><i class="fas fa-user-slash text-danger"></i> <%= complaint.reported_user.name %></div>
                  <div class="user-email"><i class="fas fa-envelope"></i> <%= complaint.reported_user.email %></div>
                  <div class="user-id">ID: <%= complaint.to_user_id %></div>
                </div>
              <% else %>
                <span class="text-muted">Usuario eliminado</span>
              <% end %>
            </td>
            
            <td class="col-reason">
              <span class="badge reason-badge badge-warning">
                <%= complaint.reason %>
              </span>
              <% if complaint.text.present? %>
                <br>
                <small class="text-muted" style="display: block; margin-top: 5px;">
                  <%= truncate(complaint.text, length: 80) %>
                  <% if complaint.text.length > 80 %>
                    <a href="#" data-toggle="modal" data-target="#textModal<%= complaint.id %>" class="text-primary">
                      ver más
                    </a>
                  <% end %>
                </small>
              <% end %>
            </td>
            
            <td class="col-date">
              <i class="far fa-clock"></i> <%= complaint.created_at.strftime("%d-%m-%Y") %><br>
              <%= complaint.created_at.strftime("%H:%M") %>
            </td>
            
            <td class="col-actions" style="text-align: center;">
              <% if complaint.action_taken == 'no_action' %>
                <span class="badge badge-warning">Sin revisar</span>
              <% else %>
                <span class="badge badge-success">Revisado</span>
              <% end %>
            </td>
            
            <td class="col-actions" style="min-width: 140px;">
              <% if complaint.reported_user.blank? %>
                <span class="badge badge-light text-muted">
                  <i class="fas fa-user-slash"></i> Usuario eliminado
                </span>
              <% elsif complaint.action_taken == 'no_action' %>
                <div style="display: flex; flex-direction: column; gap: 4px;">
                  <button type="button" 
                          class="btn btn-sm btn-danger" 
                          style="font-size: 11px; padding: 4px 8px; width: 100%;"
                          data-toggle="modal" 
                          data-target="#blockModal<%= complaint.id %>">
                    Bloquear usuario
                  </button>
                  <button type="button" 
                          class="btn btn-sm btn-secondary" 
                          style="font-size: 11px; padding: 4px 8px; width: 100%;"
                          data-toggle="modal" 
                          data-target="#ignoreModal<%= complaint.id %>">
                    Ignorar denuncia
                  </button>
                </div>
              <% else %>
                <% if complaint.action_taken == 'user_blocked' %>
                  <span class="badge badge-danger"><i class="fas fa-ban"></i> Usuario bloqueado</span>
                <% elsif complaint.action_taken == 'invalidated' %>
                  <span class="badge badge-secondary"><i class="fas fa-times-circle"></i> Denuncia ignorada</span>
                <% end %>
              <% end %>
            </td>
            
            <td class="col-actions">
              <%= link_to complaint, method: :delete,
                  data: { confirm: '¿Eliminar esta denuncia?' },
                  class: 'btn btn-danger btn-action',
                  title: 'Eliminar denuncia' do %>
                <i class="fas fa-trash"></i>
              <% end %>
            </td>
          </tr>
          
          <!-- Modal para bloquear usuario -->
          <div class="modal fade" id="blockModal<%= complaint.id %>" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                  <h5 class="modal-title"><i class="fas fa-ban"></i> Confirmar bloqueo</h5>
                  <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <p><strong>¿Estás seguro de bloquear a este usuario?</strong></p>
                  <p>Usuario denunciado: <strong><%= complaint.reported_user&.name || 'Usuario eliminado' %></strong></p>
                  <p>Razón: <strong><%= complaint.reason %></strong></p>
                  <p class="text-muted"><small>Esta acción bloqueará al usuario denunciado y marcará la denuncia como revisada.</small></p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                  <%= form_with model: complaint, local: true, class: 'complaint-action-form', data: { complaint_id: complaint.id } do |f| %>
                    <%= f.hidden_field :action_taken, value: 'user_blocked' %>
                    <%= f.submit 'Sí, bloquear usuario', class: 'btn btn-danger' %>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Modal para ignorar denuncia -->
          <div class="modal fade" id="ignoreModal<%= complaint.id %>" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                  <h5 class="modal-title"><i class="fas fa-times-circle"></i> Confirmar ignorar</h5>
                  <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <p><strong>¿Estás seguro de ignorar esta denuncia?</strong></p>
                  <p>Razón: <strong><%= complaint.reason %></strong></p>
                  <p class="text-muted"><small>Esta acción marcará la denuncia como revisada pero no tomará ninguna acción contra el usuario denunciado.</small></p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                  <%= form_with model: complaint, local: true, class: 'complaint-action-form', data: { complaint_id: complaint.id } do |f| %>
                    <%= f.hidden_field :action_taken, value: 'invalidated' %>
                    <%= f.submit 'Sí, ignorar denuncia', class: 'btn btn-warning' %>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Modal para texto completo -->
          <% if complaint.text && complaint.text.length > 100 %>
            <div class="modal fade" id="textModal<%= complaint.id %>" tabindex="-1" role="dialog">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title">Descripción Completa</h5>
                    <button type="button" class="close" data-dismiss="modal">
                      <span>&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <p><strong>Razón:</strong> <%= complaint.reason %></p>
                    <p><strong>Descripción:</strong></p>
                    <p><%= complaint.text %></p>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
          
          <!-- Modal para perfil del denunciante -->
          <div class="modal fade" id="userModal<%= complaint.user_id %>" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                  <h5 class="modal-title"><i class="fas fa-user"></i> Perfil del Denunciante</h5>
                  <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>ID:</strong> <%= complaint.user_id %></p>
                      <p><strong>Nombre:</strong> <%= complaint.user.name %></p>
                      <p><strong>Email:</strong> <%= complaint.user.email %></p>
                      <p><strong>Teléfono:</strong> <%= complaint.user.phone || 'No disponible' %></p>
                      <p><strong>Género:</strong> <%= complaint.user.gender || 'No especificado' %></p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>Edad:</strong> <%= complaint.user.birthday.present? ? ((Date.today - complaint.user.birthday.to_date) / 365.25).to_i : 'No disponible' %></p>
                      <p><strong>Ubicación:</strong>
                        <% if complaint.user.location_country.present? || complaint.user.location_city.present? %>
                          <%= [complaint.user.location_city, complaint.user.location_country].compact.join(', ') %>
                        <% elsif complaint.user.living_in.present? %>
                          <%= complaint.user.living_in %>
                        <% elsif complaint.user.locality.present? %>
                          <%= complaint.user.locality %>
                        <% else %>
                          No disponible
                        <% end %>
                      </p>
                      <p><strong>Fecha de registro:</strong> <%= complaint.user.created_at.strftime("%d-%m-%Y") %></p>
                      <p><strong>Verificado:</strong> <%= complaint.user.verified ? '✓ Sí' : '✗ No' %></p>
                      <p><strong>Bloqueado:</strong> <%= complaint.user.blocked ? '✓ Sí' : '✗ No' %></p>
                      <p><strong>Cuenta eliminada:</strong> <%= complaint.user.deleted_account ? '✓ Sí' : '✗ No' %></p>
                    </div>
                  </div>
                  <hr>
                  <div class="text-center">
                    <%= link_to 'Ver perfil completo', show_user_path(id: complaint.user_id), class: 'btn btn-outline-primary btn-sm', target: '_blank' %>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Modal para perfil del denunciado -->
          <% if complaint.reported_user.present? %>
            <div class="modal fade" id="reportedUserModal<%= complaint.to_user_id %>" tabindex="-1" role="dialog">
              <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                  <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-user-slash"></i> Perfil del Denunciado</h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                      <span>&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <div class="row">
                      <div class="col-md-6">
                        <p><strong>ID:</strong> <%= complaint.to_user_id %></p>
                        <p><strong>Nombre:</strong> <%= complaint.reported_user.name %></p>
                        <p><strong>Email:</strong> <%= complaint.reported_user.email %></p>
                        <p><strong>Teléfono:</strong> <%= complaint.reported_user.phone || 'No disponible' %></p>
                        <p><strong>Género:</strong> <%= complaint.reported_user.gender || 'No especificado' %></p>
                      </div>
                      <div class="col-md-6">
                        <p><strong>Edad:</strong> <%= complaint.reported_user.birthday.present? ? ((Date.today - complaint.reported_user.birthday.to_date) / 365.25).to_i : 'No disponible' %></p>
                        <p><strong>Ubicación:</strong>
                          <% if complaint.reported_user.location_country.present? || complaint.reported_user.location_city.present? %>
                            <%= [complaint.reported_user.location_city, complaint.reported_user.location_country].compact.join(', ') %>
                          <% elsif complaint.reported_user.living_in.present? %>
                            <%= complaint.reported_user.living_in %>
                          <% elsif complaint.reported_user.locality.present? %>
                            <%= complaint.reported_user.locality %>
                          <% else %>
                            No disponible
                          <% end %>
                        </p>
                        <p><strong>Fecha de registro:</strong> <%= complaint.reported_user.created_at.strftime("%d-%m-%Y") %></p>
                        <p><strong>Verificado:</strong> <%= complaint.reported_user.verified ? '✓ Sí' : '✗ No' %></p>
                        <p><strong>Bloqueado:</strong> <%= complaint.reported_user.blocked ? '✓ Sí' : '✗ No' %></p>
                        <p><strong>Cuenta eliminada:</strong> <%= complaint.reported_user.deleted_account ? '✓ Sí' : '✗ No' %></p>
                      </div>
                    </div>
                    <hr>
                    <div class="alert alert-warning">
                      <strong>Denuncias recibidas:</strong> <%= Complaint.where(to_user_id: complaint.to_user_id).count %>
                    </div>
                    <div class="text-center">
                      <%= link_to 'Ver perfil completo', show_user_path(id: complaint.to_user_id), class: 'btn btn-outline-danger btn-sm', target: '_blank' %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
