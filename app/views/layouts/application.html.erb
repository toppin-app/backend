<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <title><%= @meta_title %></title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag 'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <%= javascript_pack_tag 'application', 'data-turbolinks-track': 'reload' %>
  
  <%= favicon_link_tag asset_path('favicon.png') %>
  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/css/tempusdominus-bootstrap-4.css" integrity="sha512-ClXpwbczwauhl7XC16/EFu3grIlYTpqTYOwqwAi7rNSqxmTqCpE8VS3ovG+qi61GoxSLnuomxzFXDNcPV1hvCQ==" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/icheck-bootstrap/3.0.1/icheck-bootstrap.min.css" integrity="sha512-8vq2g5nHE062j3xor4XxPeZiPjmRDh6wlufQlfC6pdQ/9urJkU07NM0tEREeymP++NczacJ/Q59ul+/K2eYvcg==" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.13.1/css/OverlayScrollbars.min.css" integrity="sha512-jN4O0AUkRmE6Jwc8la2I5iBmS+tCDcfUd1eq8nrZIBnDKTmCp5YxxNN1/aetnAH32qT+dDbk1aGhhoaw5cJNlw==" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.0.5/daterangepicker.min.css" integrity="sha512-rBi1cGvEdd3NmSAQhPWId5Nd6QxE8To4ADjM2a6n0BrqQdisZ/RPUlm0YycDzvNL1HHAh1nKZqI0kSbif+5upQ==" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/summernote-bs4.min.css" integrity="sha512-pDpLmYKym2pnF0DNYDKxRnOk1wkM9fISpSOjt8kWFKQeDmBTjSnBZhTd41tXwh8+bRMoSaFsRnznZUiH9i3pxA==" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/5.7.1/tinymce.min.js" integrity="sha512-RnlQJaTEHoOCt5dUTV0Oi0vOBMI9PjCU7m+VHoJ4xmhuUNcwnB5Iox1es+skLril1C3gHTLbeRepHs1RpSCLoQ==" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome-animation/0.3.0/font-awesome-animation.min.css" integrity="sha512-Po8rrCwchD03Wo+2ibHFielZ8luDAVoCyE9i6iFMPyn9+V1tIhGk5wl8iKC9/JfDah5Oe9nV8QzE8HHgjgzp3g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">

  </head>

  <body class="hold-transition sidebar-mini layout-fixed" style="margin: 0">

    <div class="wrapper">



  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
     <!-- <li class="nav-item d-none d-sm-inline-block">
        <a href="index3.html" class="nav-link">Home</a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="#" class="nav-link">Contact</a>
      </li>-->
    </ul>

    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">



      <li class="nav-item">
        <a class="nav-link" data-widget="fullscreen" href="#" role="button">
          <i class="fas fa-expand-arrows-alt"></i>
        </a>
      </li>

    </ul>
  </nav>
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <!-- Brand Logo -->
    <a href="/" class="brand-link">

      <%= image_tag "logo-devise.png", class: "brand-image img-circle elevation-3" %>
      <span class="brand-text font-weight-light">
        <%= APP_CONFIG["app_name"] %>
      </span>
    </a>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Sidebar user panel (optional) -->
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image">
          
        </div>
        <div class="info">
          <a href="#" class="d-block"><i class="fas fa-user-tie"></i> <%= current_user.email if current_user %></a>
        </div>
      </div>



      <!-- Sidebar Menu -->
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          
          
          <li class="nav-item">
            <%= link_to users_path, class: "nav-link" do %>
              <i class="nav-icon far fa-user"></i>
              <p>
                Usuarios
              </p>
            <% end %>
          </li>


<!--
          <li class="nav-item">
            <%= link_to interests_path, class: "nav-link" do %>
              <i class="fas fa-user-check"></i>
              <p>
                Intereses
              </p>
            <% end %>
          </li>
-->


          <li class="nav-item">
            <%= link_to interests_path, class: "nav-link" do %>
              <i class="fas fa-users-cog"></i>
              <p>
                Intereses
              </p>
            <% end %>
          </li>

          <li class="nav-item">
            <%= link_to info_item_categories_path, class: "nav-link" do %>
              <i class="fas fa-users-cog"></i>
              <p>
                Categorías de perfil
              </p>
            <% end %>
          </li>


          <li class="nav-item">
            <%= link_to complaints_path, class: "nav-link" do %>
              <i class="far fa-id-badge"></i>
              <p>
                Denuncias
              </p>
            <% end %>
          </li>



          <li class="nav-item">
            <%= link_to publis_path, class: "nav-link" do %>
              <i class="fab fa-adversal"></i>
              <p>
                Publicidad
              </p>
            <% end %>
          </li>

          <li class="nav-item">
            <%= link_to banners_path, class: "nav-link" do %>
              <i class="fas fa-ad"></i>
              <p>
                Banners
              </p>
            <% end %>
          </li>

          <li class="nav-item">
            <%= link_to app_versions_path, class: "nav-link" do %>
              <i class="fas fa-mobile-alt"></i>
              <p>
                Versiones de la App
              </p>
            <% end %>
          </li>

          <li class="nav-item">
            <%= link_to admin_mailer_test_path, class: "nav-link" do %>
              <i class="fas fa-envelope"></i>
              <p>
                Test de Emails
              </p>
            <% end %>
          </li>

          <li class="nav-item">

            <%= link_to logout_path, class: 'nav-link' do %>
              <i class="fas fa-sign-out-alt"></i>
              <p>
                Salir
              </p>
            <% end %>
          </li>
        </ul>
      </nav>
      <!-- /.sidebar-menu -->
    </div>
    <!-- /.sidebar -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1 class="m-0"><%= @title %></h1>
          </div><!-- /.col -->
          <div class="col-sm-6">

          </div><!-- /.col -->
        </div><!-- /.row -->
      </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
          <% if alert %>
           <p class="alert alert-danger">
             <%= alert %>
            </p>
          <% end %>

          <% if notice %>
           <p class="alert alert-info">
             <%= notice %>
            </p>
          <% end %>


          <%= yield %>
      </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->
  <footer class="main-footer">
    <strong>Copyright &copy; <%= Date.today.strftime("%Y") %> <%= APP_CONFIG["copyright"] %> | <a href="www.toppin.es">Powered by Toppin</a>.</strong>
    All rights reserved.

  </footer>

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>



    <!-- jQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- jQuery UI 1.11.4 -->

<script>
  // A $( document ).ready() block.
$( document ).ready(function() {
      tinymce.init({
      selector: 'textarea.editable',  // change this value according to your HTML
      plugin: 'a_tinymce_plugin',
      a_plugin_option: true,
      a_configuration_option: 400,
      height: 300,
      plugins: [
          'advlist autolink link image lists charmap hr anchor pagebreak',
          'searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime nonbreaking',
          'table emoticons template paste'
        ],
        toolbar: 'undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | ' +
          'bullist numlist outdent indent | link image  | ' +
          'forecolor backcolor emoticons | help',
    });


   $(".setdeliver").click(function(e){
      var id = $(this).attr("data-id")
      var time = prompt("Introduce tiempo de entrega estimado (en minutos)", "30");
      
      $.post( "/set_deliver_time", { id: id, time: time })
        .done(function( data ) {
          console.log(data)
          location.reload()
        });
   })


   $(".setdelivered").click(function(e){


    if (confirm("¿Marcar como enviado?")) {

      var id = $(this).attr("data-id")      
      $.post( "/set_delivered", { id: id })
        .done(function( data ) {
          console.log(data)
          location.reload()
        });

    } 

      



   })

      
})
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha512-uto9mlQzrs59VwILcLiRYeLKPPbS/bT71da/OEBYEwcdNUk8jYIy+D176RYoop1Da+f9mvkYrmj5MCLZWEtQuA==" crossorigin="anonymous"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
  $.widget.bridge('uibutton', $.ui.button)
</script>
<!-- Bootstrap 4 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.bundle.min.js" integrity="sha512-wV7Yj1alIZDqZFCUQJy85VN+qvEIly93fIQAN7iqDFCPEucLCeNFz4r35FCo9s6WrpdDQPi80xbljXB8Bjtvcg==" crossorigin="anonymous"></script>
<!-- ChartJS -->
<!--
<script src="plugins/chart.js/Chart.min.js"></script>

<script src="plugins/sparklines/sparkline.js"></script>

<script src="plugins/jqvmap/jquery.vmap.min.js"></script>
<script src="plugins/jqvmap/maps/jquery.vmap.usa.js"></script>

<script src="plugins/jquery-knob/jquery.knob.min.js"></script>
-->

<!-- daterangepicker -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.0.5/daterangepicker.min.js" integrity="sha512-mh+AjlD3nxImTUGisMpHXW03gE6F4WdQyvuFRkjecwuWLwD2yCijw4tKA3NsEFpA1C3neiKhGXPSIGSfCYPMlQ==" crossorigin="anonymous"></script>

<!-- Tempusdominus Bootstrap 4 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/js/tempusdominus-bootstrap-4.min.js"></script>
<!-- Summernote -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.18/summernote-bs4.min.js" integrity="sha512-+cXPhsJzyjNGFm5zE+KPEX4Vr/1AbqCUuzAS8Cy5AfLEWm9+UI9OySleqLiSQOQ5Oa2UrzaeAOijhvV/M4apyQ==" crossorigin="anonymous"></script>
<!-- overlayScrollbars -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/overlayscrollbars/1.13.1/js/OverlayScrollbars.min.js"></script>
<!-- AdminLTE App -->
<script src="/dist/adminlte.min.js"></script>

<script src="https://media.twiliocdn.com/sdk/js/conversations/releases/2.0.0/twilio-conversations.min.js"
  integrity="sha256-/pQ4lYklKpRl6E4ruYcKqTUcLsfM2FQLUarDWVA9I0o="
  crossorigin="anonymous"></script>

  <!-- Latest compiled and minified JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>



<% if controller.controller_name == "users" and controller.action_name == "show" %>
  <script>

    twilioClient = null
    var userId = "<%= @user.id %>"
    var currentSid = null



    Twilio.Conversations.Client.create("<%= @token %>").then(client => {
        // Use client
        twilioClient = client
        console.log(twilioClient)

         $(".chat").removeClass('disabled')

          twilioClient.on('messageAdded', value => {
              console.log("twilio messageAdded", value)

              if (value.conversation.sid != currentSid){
                $("#"+value.conversation.sid).removeClass('btn-primary')
                $("#"+value.conversation.sid).addClass('btn-success')
                $("#"+value.conversation.sid).addClass('blink_me')
              }
          })


    });


    function startConversation(sid){

        console.log("sid", sid)

        if (sid == currentSid) return;

        twilioClient.getConversationBySid(sid).then(conv => {

          console.log("conv", conv)

          currentSid = conv.sid

          $("#conversation").empty()

          conv.on('messageAdded', value => {

              console.log("messageAdded", value)
              console.log(value.conversation.sid)
              console.log(currentSid)

              if (value.conversation.sid != currentSid)
                return
              
              

              if (value.author == userId)
                $("#conversation").append('<p class="alert alert-info"><b>Tú</b>, <small>'+value.dateCreated+'</small><br>'+value.body+'</p>')
              else
                $("#conversation").append('<p class="alert alert-warning"><small>'+value.dateCreated+'</small><br>'+value.body+'</p>')

              var d = $('#conversation');
              d.scrollTop(d.prop("scrollHeight"));

          })


            conv.getMessages().then(messages => {

              console.log(messages)

              $.each( messages.items, function( key, value ) {
                  
                  if (value.author == userId)
                     $("#conversation").append('<p class="alert alert-info"><b>Tú</b>, <small>'+value.dateCreated+'</small><br>'+value.body+'</p>')
                  else
                    $("#conversation").append('<p class="alert alert-warning"><small>'+value.dateCreated+'</small><br>'+value.body+'</p>')

              });

              var d = $('#conversation');
              d.scrollTop(d.prop("scrollHeight"));


            })

        })


    }


    function sendMessage(message){

      twilioClient.getConversationBySid(currentSid).then(conv => {

        conv.sendMessage(message, { isRead: false }).then(msg => {
           console.log("message",msg)
        })

      })

    }


    $("#message").on('keypress',function(e) {
      if(e.which == 13) {
          sendMessage($("#message").val())
          $("#message").val('')
      }
    });


    $(".chat").click(function(e) {
       sid = $(this).attr("data-sid")
       startConversation(sid)

              $(this).removeClass('btn-success')
              $(this).removeClass('blink_me')
              $(this).addClass('btn-primary')

    })


   </script>

   <% end %>

  </body>
</html>